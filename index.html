<!DOCTYPE html>

<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>StreamDag</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root {
      --bg: #050509; --card: #11111b; --accent: #0a84ff; --accent2: #32d74b;
      --t1: #f5f5f7; --t2: #a1a1b2; --t3: #6b6b7a; --s3: #232331;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      background:radial-gradient(circle at top,#141420 0,#050509 55%);
      color:var(--t1); -webkit-font-smoothing:antialiased;
    }
    .app{ min-height:100vh; max-width:900px; margin:0 auto; padding:24px 16px 40px; }
    header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; }
    .logo-wrap{ display:flex; align-items:center; gap:10px; }
    .logo-dot{
      width:26px; height:26px; border-radius:9px;
      background:radial-gradient(circle at 30% 20%,#fff 0,rgba(255,255,255,0.35) 40%,transparent 65%),
                 linear-gradient(135deg,#0a84ff,#32d74b);
      box-shadow:0 0 0 0.5px rgba(255,255,255,0.35),0 8px 18px rgba(0,0,0,0.7);
    }
    .title-main{ font-weight:600; letter-spacing:-0.02em; font-size:20px; }
    .title-sub{ font-size:12px; color:var(--t3); }
    .pill-row{ display:flex; gap:8px; margin-bottom:12px; }
    .pill{
      padding:6px 12px; border-radius:999px; border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.03); color:var(--t2); font-size:12px;
      display:flex; align-items:center; gap:6px; cursor:pointer; transition:all .18s ease;
    }
    .pill.active{
      border-color:rgba(10,132,255,0.7);
      background:linear-gradient(135deg,rgba(10,132,255,0.2),rgba(50,215,75,0.08));
      color:var(--t1); box-shadow:0 0 0 1px rgba(10,132,255,0.3);
    }
    .pill span.icon{ font-size:14px; }
    .svc-bar{
      display:flex; overflow-x:auto; gap:8px; padding:6px 2px 6px 0;
      margin-bottom:8px; -webkit-overflow-scrolling:touch;
    }
    .svc-bar::-webkit-scrollbar{display:none}
    .sc{
      flex:0 0 auto; display:flex; align-items:center; gap:6px; padding:6px 10px;
      border-radius:999px; background:rgba(15,15,24,0.9); border:1px solid rgba(255,255,255,0.06);
      color:var(--t2); font-size:11px; cursor:pointer; transition:all .16s ease;
    }
    .sc img{ width:16px; height:16px; border-radius:4px; object-fit:cover; }
    .sc .dot{ width:10px; height:10px; border-radius:999px; }
    .sc.active{
      border-color:rgba(10,132,255,0.75);
      background:linear-gradient(135deg,rgba(10,132,255,0.25),rgba(50,215,75,0.12));
      color:var(--t1); box-shadow:0 0 0 1px rgba(10,132,255,0.4);
    }
    .nav-bar{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:8px; }
    .nav-btn{
      display:flex; align-items:center; gap:6px; padding:8px 14px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.04);
      color:var(--t2); font-size:12px; font-weight:500; cursor:pointer;
      transition:all .16s ease; white-space:nowrap;
    }
    .nav-btn:hover:not(:disabled){ border-color:rgba(10,132,255,0.5); color:var(--t1); }
    .nav-btn:disabled{ opacity:0.3; cursor:default; pointer-events:none; }
    .nav-range{ font-size:12px; color:var(--t3); text-align:center; flex:1; }
    .loading-screen,.error-screen{
      min-height:50vh; display:flex; flex-direction:column;
      align-items:center; justify-content:center; text-align:center; color:var(--t2);
    }
    .spinner{
      width:22px; height:22px; border-radius:999px; border:2px solid rgba(255,255,255,0.08);
      border-top-color:var(--accent); animation:spin 0.8s linear infinite; margin-bottom:14px;
    }
    .loading-text{ font-size:14px; }
    .error-icon{ font-size:32px; margin-bottom:10px; }
    .error-title{ font-weight:600; margin-bottom:4px; }
    .error-msg{ font-size:13px; color:var(--t3); max-width:300px; margin:0 auto 14px; line-height:1.5; }
    .retry-btn{
      border:none; outline:none; padding:8px 16px; border-radius:999px;
      background:var(--accent); color:#fff; font-size:13px; font-weight:500;
      cursor:pointer; box-shadow:0 6px 16px rgba(10,132,255,0.6);
    }
    .day-section{
      margin-top:18px; padding:16px 12px 18px; border-radius:18px;
      background:linear-gradient(145deg,rgba(17,17,26,0.96),rgba(8,8,14,0.98));
      border:1px solid rgba(255,255,255,0.04); box-shadow:0 16px 35px rgba(0,0,0,0.75);
      animation:fadeUp .35s ease forwards; opacity:0; transform:translateY(8px);
    }
    .day-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:2px; }
    .day-name{ font-size:14px; font-weight:600; letter-spacing:0.01em; }
    .today-chip{
      font-size:11px; padding:3px 8px; border-radius:999px;
      background:rgba(10,132,255,0.15); color:var(--accent); border:1px solid rgba(10,132,255,0.55);
    }
    .day-sub{ font-size:12px; color:var(--t3); margin-bottom:8px; }
    .cat-row{ font-size:12px; color:var(--t2); margin:10px 0 6px; }
    .scroll-track{
      display:flex; gap:10px; overflow-x:auto; padding-bottom:4px;
      margin-bottom:6px; -webkit-overflow-scrolling:touch;
    }
    .scroll-track::-webkit-scrollbar{height:0}
    .card{
      flex:0 0 142px; background:var(--card); border-radius:16px;
      border:1px solid rgba(255,255,255,0.06); padding:6px 6px 10px; cursor:pointer;
      transition:transform .16s ease,box-shadow .16s ease,background .16s ease,border-color .16s ease;
      box-shadow:0 10px 22px rgba(0,0,0,0.7);
    }
    .card:hover{
      transform:translateY(-2px); box-shadow:0 16px 30px rgba(0,0,0,0.9);
      border-color:rgba(10,132,255,0.5);
      background:radial-gradient(circle at top,rgba(10,132,255,0.16),var(--card));
    }
    .card-poster{
      position:relative; border-radius:12px; overflow:hidden;
      background:var(--s3); margin-bottom:6px; aspect-ratio:2/3;
    }
    .card-poster img.poster{ width:100%; height:100%; object-fit:cover; display:block; }
    .fallback{
      position:absolute; inset:0; display:flex; align-items:center;
      justify-content:center; padding:8px; color:var(--t2); font-size:11px; text-align:center;
    }
    .new-label{
      position:absolute; top:6px; left:6px; font-size:10px; padding:2px 6px;
      border-radius:999px; background:rgba(50,215,75,0.92); color:#000; font-weight:600;
    }
    .badge{
      position:absolute; bottom:6px; left:6px; font-size:10px; padding:2px 6px;
      border-radius:999px; display:inline-flex; align-items:center;
      max-width:75%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      backdrop-filter:blur(12px);
    }
    .card-title{ font-size:12px; font-weight:500; line-height:1.2; margin-bottom:2px; max-height:2.4em; overflow:hidden; }
    .card-meta{ font-size:11px; color:var(--t3); }
    .empty-day{ font-size:13px; color:var(--t3); padding:8px 0; }
    .divider{ margin-top:10px; height:1px; background:linear-gradient(to right,rgba(255,255,255,0.12),rgba(255,255,255,0.02)); }
    #overlay{
      position:fixed; inset:0; background:rgba(3,3,8,0.88);
      backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
      display:none; align-items:flex-end; justify-content:center; z-index:20;
    }
    #overlay.open{ display:flex; }
    .sheet{
      width:100%; max-width:640px; border-radius:22px 22px 0 0;
      background:linear-gradient(160deg,#101018,#06060d); padding:14px 16px 18px;
      border:1px solid rgba(255,255,255,0.08); border-bottom:none;
      box-shadow:0 -18px 40px rgba(0,0,0,0.95);
      max-height:85vh; display:flex; flex-direction:column; animation:slideUp .28s ease-out;
    }
    .drag{ width:36px; height:4px; border-radius:999px; background:rgba(255,255,255,0.2); margin:0 auto 8px; }
    .sheet-header{ display:flex; gap:12px; margin-bottom:10px; }
    .sp{ width:84px; height:126px; border-radius:14px; overflow:hidden; background:var(--s3); flex-shrink:0; }
    .sp img{ width:100%; height:100%; object-fit:cover; }
    .sinf{ flex:1; min-width:0; }
    .ssvc{ font-size:11px; text-transform:uppercase; letter-spacing:0.08em; color:var(--t2); margin-bottom:3px; }
    .stitle{ font-size:16px; font-weight:600; margin-bottom:2px; }
    .smeta{ font-size:12px; color:var(--t3); margin-bottom:4px; }
    .stags{ font-size:11px; margin-bottom:4px; }
    .stag{
      display:inline-block; padding:2px 7px; border-radius:999px;
      background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.14);
      margin-right:4px; margin-bottom:3px;
    }
    .srating{ font-size:12px; color:var(--t2); margin-bottom:6px; }
    .sheet-body{ font-size:13px; color:var(--t2); line-height:1.6; overflow:auto; padding-right:2px; margin-bottom:8px; }
    .svc-logos{ display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
    .svc-chip{
      display:inline-flex; align-items:center; gap:5px; padding:3px 8px;
      border-radius:999px; font-size:11px; border:1px solid rgba(255,255,255,0.1);
      background:rgba(255,255,255,0.05);
    }
    .svc-chip img{ width:14px; height:14px; border-radius:3px; object-fit:cover; }
    .watch-btn{
      width:100%; display:flex; align-items:center; justify-content:center; gap:6px;
      padding:9px 14px; border-radius:999px; border:none; outline:none;
      background:linear-gradient(135deg,#0a84ff,#32d74b); color:#fff;
      font-size:14px; font-weight:600; text-decoration:none; margin-top:4px;
      box-shadow:0 8px 22px rgba(10,132,255,0.8); cursor:pointer;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    @media(min-width:768px){.app{padding-top:28px}}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo-wrap">
      <div class="logo-dot"></div>
      <div>
        <div class="title-main">StreamDag</div>
        <div class="title-sub">Wat is nieuw op streaming vandaag</div>
      </div>
    </div>
  </header>

  <div class="pill-row">
    <div class="pill active" data-f="all"   onclick="setType(this)"><span class="icon">‚óé</span>Alles</div>
    <div class="pill"        data-f="movie" onclick="setType(this)"><span class="icon">üé¨</span>Films</div>
    <div class="pill"        data-f="tv"    onclick="setType(this)"><span class="icon">üì∫</span>Series</div>
  </div>

  <div id="svcBar" class="svc-bar"></div>

  <div class="nav-bar" id="navBar" style="display:none">
    <button class="nav-btn" id="btnPrev" onclick="shiftWindow(-7)">‚óÄ Ga terug</button>
    <div class="nav-range" id="navRange"></div>
    <button class="nav-btn" id="btnNext" onclick="shiftWindow(7)">Ga verder ‚ñ∂</button>
  </div>

  <main id="main">
    <div class="loading-screen">
      <div class="spinner"></div>
      <div class="loading-text">Streamingdiensten ophalen‚Ä¶</div>
    </div>
  </main>
</div>

<div id="overlay" onclick="closeBg(event)">
  <div class="sheet">
    <div class="drag"></div>
    <div class="sheet-header"><div id="si"></div></div>
    <div id="sd" class="sheet-body"></div>
    <a id="wb" class="watch-btn" href="#" target="_blank" rel="noopener noreferrer" style="display:none">
      <span>‚ñ∂</span> Nu kijken
    </a>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CORS proxy + JustWatch basis ‚îÄ‚îÄ
const PROXY   = 'https://corsproxy.io/?';
const JW_BASE = 'https://apis.justwatch.com/content';
const JW_IMG  = 'https://images.justwatch.com';
const LOCALE  = 'nl_NL';

const GENRE_NL = {
  'act':'Actie','ani':'Animatie','com':'Komedie','cri':'Misdaad',
  'doc':'Documentaire','dra':'Drama','fan':'Fantasy','hor':'Horror',
  'his':'Geschiedenis','mys':'Mystery','rom':'Romantiek','scf':'Sci-Fi',
  'trl':'Thriller','was':'Western','fam':'Familie','mus':'Musical',
  'bio':'Biografie','adv':'Avontuur','war':'Oorlog','rea':'Reality',
  'sho':'Talkshow','kid':'Kinderen','spr':'Sport',
};

const SVC_COLORS = {
  'nfx':{color:'#E50914',text:'#fff'},
  'dnp':{color:'#113CCF',text:'#fff'},
  'amp':{color:'#00A8E0',text:'#fff'},
  'atp':{color:'#555',   text:'#fff'},
  'mxx':{color:'#5822B4',text:'#fff'},
  'hbm':{color:'#5822B4',text:'#fff'},
  'vdl':{color:'#D4001A',text:'#fff'},
  'npo':{color:'#FF6200',text:'#fff'},
  'prv':{color:'#00A8E0',text:'#fff'},
  'default':{color:'#444',text:'#fff'},
};
function getSvcStyle(sn){ return SVC_COLORS[(sn||'').toLowerCase()]||SVC_COLORS.default; }

function posterUrl(path, size=166){
  if(!path) return null;
  if(path.startsWith('http')) return path;
  return JW_IMG + path.replace('{profile}',`s${size}`);
}

function seemsDutch(t){
  const dw=['de','het','een','en','van','in','is','dat','zijn','met','op','voor','aan'];
  return (t||'').toLowerCase().split(/\s+/).filter(w=>dw.includes(w)).length >= 3;
}
async function translateToNL(text){
  if(!text||!text.trim()) return 'Geen beschrijving beschikbaar.';
  if(seemsDutch(text)) return text;
  try{
    const r=await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text.slice(0,500))}&langpair=en|nl`);
    const d=await r.json();
    const t=d?.responseData?.translatedText;
    return(t&&t!==text)?t:text;
  }catch{ return text; }
}

// ‚îÄ‚îÄ Fetch helpers via CORS proxy ‚îÄ‚îÄ
async function jwGet(path){
  const url = PROXY + encodeURIComponent(JW_BASE + path);
  const r = await fetch(url, { headers:{ 'x-requested-with':'XMLHttpRequest' } });
  if(!r.ok) throw new Error(`JW GET ${r.status}`);
  return r.json();
}
async function jwPost(path, body){
  const url = PROXY + encodeURIComponent(JW_BASE + path);
  const r = await fetch(url, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'x-requested-with':'XMLHttpRequest' },
    body: JSON.stringify(body),
  });
  if(!r.ok) throw new Error(`JW POST ${r.status}`);
  return r.json();
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let provMap    = {};
let allItems   = [];
let typeFilter = 'all';
let svcFilter  = 'all';
const WINDOW_SIZE = 7;
let allDays    = [];
let windowStart = 0;

function todayISO(){ return new Date().toISOString().slice(0,10); }
function dayName(iso){
  const n=new Date(iso+'T12:00:00').toLocaleDateString('nl-NL',{weekday:'long'});
  return n.charAt(0).toUpperCase()+n.slice(1);
}
function fullDate(iso){
  return new Date(iso+'T12:00:00').toLocaleDateString('nl-NL',{day:'numeric',month:'long',year:'numeric'});
}
function shortDate(iso){
  return new Date(iso+'T12:00:00').toLocaleDateString('nl-NL',{day:'numeric',month:'short'});
}
function setLoadingText(t){ const el=document.querySelector('.loading-text'); if(el) el.textContent=t; }

// ‚îÄ‚îÄ 1. Providers ‚îÄ‚îÄ
async function fetchProviders(){
  const data = await jwGet(`/providers/locale/${LOCALE}`);
  const list = Array.isArray(data) ? data : [];
  list.forEach(p => { provMap[p.id] = p; });
}

// ‚îÄ‚îÄ 2. New titles (flatrate only) ‚îÄ‚îÄ
async function fetchTitles(){
  setLoadingText('Nieuwe releases ophalen‚Ä¶');

  const pages = await Promise.allSettled([1,2,3,4].map(page =>
    jwPost(`/titles/${LOCALE}/new`, {
      content_types: ['show','movie'],
      monetization_types: ['flatrate'],
      page,
      page_size: 100,
    })
  ));

  const today = todayISO();
  const seen  = new Set();
  const items = [];

  pages.forEach(res => {
    if(res.status!=='fulfilled') return;
    (res.value?.items||[]).forEach(item => {
      if(seen.has(item.id)) return;
      seen.add(item.id);

      const flat = (item.offers||[]).filter(o=>o.monetization_type==='flatrate');
      if(!flat.length) return;

      // Best stream date
      const dates = flat
        .map(o=>(o.available_from||o.last_change_date||'').slice(0,10))
        .filter(Boolean).sort().reverse();
      const streamDate = dates[0] || today;

      // Primary offer
      const offer    = flat[0];
      const prov     = provMap[offer.provider_id]||{};
      const sn       = offer.package_short_name || prov.short_name || '';
      const style    = getSvcStyle(sn);
      const provName = prov.clear_name || sn || 'Streaming';

      // All unique providers
      const seenP = new Set();
      const allProvs = flat.map(o=>({
        id: o.provider_id,
        sn: o.package_short_name||(provMap[o.provider_id]||{}).short_name||'',
        name:(provMap[o.provider_id]||{}).clear_name||o.package_short_name||'',
        icon:(provMap[o.provider_id]||{}).icon_url||null,
        url: o.urls?.standard_web||null,
      })).filter(p=>{ if(seenP.has(p.id)) return false; seenP.add(p.id); return true; });

      const imdb   = (item.scoring||[]).find(s=>s.provider_type==='imdb:score');
      const rating = imdb ? Number(imdb.value) : null;
      const genres = (item.genres||[]).map(g=>GENRE_NL[g.short_name]||g.short_name).filter(Boolean);
      const type   = item.object_type==='show' ? 'tv' : 'movie';

      items.push({
        ...item,
        _type:     type,
        _date:     streamDate,
        _style:    style,
        _sn:       sn,
        _provName: provName,
        _prov:     prov,
        _watchUrl: offer.urls?.standard_web||null,
        _allProvs: allProvs,
        _rating:   rating,
        _genres:   genres,
        _poster:   posterUrl(item.poster),
      });
    });
  });

  allItems = items.sort((a,b)=>b._date.localeCompare(a._date));
}

// ‚îÄ‚îÄ Filter ‚îÄ‚îÄ
function filteredItems(){
  return allItems.filter(i=>{
    if(typeFilter==='movie' && i._type!=='movie') return false;
    if(typeFilter==='tv'    && i._type!=='tv')    return false;
    if(svcFilter!=='all'    && i._sn!==svcFilter) return false;
    return !!i._date;
  });
}

function buildDayList(){
  const daySet=new Set();
  for(let i=-30;i<=30;i++){
    const d=new Date(); d.setDate(d.getDate()+i);
    daySet.add(d.toISOString().slice(0,10));
  }
  filteredItems().forEach(i=>daySet.add(i._date));
  allDays=[...daySet].sort();
  const today=todayISO();
  let idx=allDays.indexOf(today);
  if(idx===-1) idx=allDays.findIndex(d=>d>=today);
  if(idx===-1) idx=Math.max(0,allDays.length-WINDOW_SIZE);
  windowStart=idx;
}

function grouped(){
  const map={};
  filteredItems().forEach(i=>{
    if(!map[i._date]) map[i._date]={movies:[],tv:[]};
    if(i._type==='movie') map[i._date].movies.push(i);
    else map[i._date].tv.push(i);
  });
  return map;
}

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
function shiftWindow(delta){
  windowStart=Math.max(0,Math.min(allDays.length-WINDOW_SIZE,windowStart+delta));
  renderAll();
  window.scrollTo({top:0,behavior:'smooth'});
}
function updateNavBar(){
  const bar=document.getElementById('navBar');
  const prev=document.getElementById('btnPrev');
  const next=document.getElementById('btnNext');
  const range=document.getElementById('navRange');
  if(!allDays.length){bar.style.display='none';return;}
  bar.style.display='flex';
  const vis=allDays.slice(windowStart,windowStart+WINDOW_SIZE);
  if(vis.length) range.textContent=`${shortDate(vis[0])} ‚Äì ${shortDate(vis[vis.length-1])}`;
  prev.disabled=windowStart<=0;
  next.disabled=windowStart+WINDOW_SIZE>=allDays.length;
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function renderAll(){
  const main=document.getElementById('main');
  main.innerHTML='';
  const g=grouped(), today=todayISO();
  const vis=allDays.slice(windowStart,windowStart+WINDOW_SIZE);
  let count=0;

  vis.forEach(iso=>{
    const data=g[iso], movies=data?.movies||[], tv=data?.tv||[];
    count++;
    const sec=document.createElement('section');
    sec.className='day-section';
    sec.style.animationDelay=`${count*0.04}s`;
    const chip=iso===today?'<span class="today-chip">Vandaag</span>':'';
    let html=`
      <div class="day-header"><div class="day-name">${dayName(iso)}</div>${chip}</div>
      <div class="day-sub">${fullDate(iso)}</div>`;
    if(!movies.length&&!tv.length){
      html+=`<div class="empty-day">Geen nieuwe releases op deze dag.</div>`;
    } else {
      if(movies.length) html+=`<div class="cat-row">üé¨ &nbsp;Films (${movies.length})</div><div class="scroll-track">${movies.map(cardHtml).join('')}</div>`;
      if(tv.length)     html+=`<div class="cat-row">üì∫ &nbsp;Series (${tv.length})</div><div class="scroll-track">${tv.map(cardHtml).join('')}</div>`;
    }
    html+='<div class="divider"></div>';
    sec.innerHTML=html; main.appendChild(sec);
  });

  if(!vis.length) main.innerHTML=`<div class="loading-screen"><div class="loading-text">Geen releases gevonden.</div></div>`;
  updateNavBar();
}

function cardHtml(item){
  const title=(item.title||'').replace(/'/g,"&#39;").replace(/"/g,'&quot;');
  const style=item._style, svcName=item._provName;
  const imgEl=item._poster?`<img class="poster" src="${item._poster}" alt="${title}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`:'' ;
  const fallD=item._poster?'none':'flex';
  const rating=item._rating?`‚≠ê ${Number(item._rating).toFixed(1)}`:(item._type==='movie'?'Film':'Serie');
  return `
    <div class="card" onclick="openModal(${item.id},'${item._type}')">
      <div class="card-poster">
        ${imgEl}
        <div class="fallback" style="display:${fallD}"><span>${title}</span></div>
        <div class="new-label">Nieuw</div>
        <div class="badge" style="background:${style.color}dd;color:${style.text}">${svcName}</div>
      </div>
      <div class="card-title">${title}</div>
      <div class="card-meta">${rating}</div>
    </div>`;
}

// ‚îÄ‚îÄ Service bar ‚îÄ‚îÄ
function buildSvcBar(){
  const bar=document.getElementById('svcBar');
  bar.innerHTML=`<div class="sc active" data-id="all" onclick="setSvc(this)">Alle streamers</div>`;
  const snSeen=new Set(), usedProvs=[];
  allItems.forEach(i=>{
    if(!snSeen.has(i._sn)){ snSeen.add(i._sn); usedProvs.push({sn:i._sn,name:i._provName,prov:i._prov,style:i._style}); }
  });
  usedProvs.sort((a,b)=>(a.name||'').localeCompare(b.name||'')).forEach(({sn,name,prov,style})=>{
    const logo=prov?.icon_url?`<img src="${prov.icon_url}" alt="">`:` <div class="dot" style="background:${style.color}"></div>`;
    bar.innerHTML+=`<div class="sc" data-id="${sn}" onclick="setSvc(this)">${logo}${name}</div>`;
  });
}

// ‚îÄ‚îÄ Filters ‚îÄ‚îÄ
function setType(el){
  typeFilter=el.dataset.f;
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  buildDayList(); renderAll();
}
function setSvc(el){
  svcFilter=el.dataset.id;
  document.querySelectorAll('.sc').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  buildDayList(); renderAll();
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
async function openModal(id, type){
  const overlay=document.getElementById('overlay');
  const si=document.getElementById('si'), sd=document.getElementById('sd'), wb=document.getElementById('wb');
  const item=allItems.find(i=>i.id===id&&i._type===type)||allItems.find(i=>i.id===id);
  if(!item) return;

  const title=item.title||'‚Äî', style=item._style, svcName=item._provName;
  const posterBig=item._poster?posterUrl(item.poster,332):null;

  si.innerHTML=`
    <div class="sp">${posterBig?`<img src="${posterBig}" alt="">`:''}</div>
    <div class="sinf">
      <div class="ssvc" style="color:${style.color}">${svcName}</div>
      <div class="stitle">${title}</div>
      <div class="smeta">${type==='movie'?'üé¨ Film':'üì∫ Serie'}</div>
      <div style="color:var(--t3);font-size:12px">Details laden‚Ä¶</div>
    </div>`;
  sd.textContent=''; wb.style.display='none';
  overlay.classList.add('open'); document.body.style.overflow='hidden';

  const genres=(item._genres||[]).slice(0,4).map(g=>`<span class="stag">${g}</span>`).join('');
  const rating=item._rating?`${Number(item._rating).toFixed(1)} / 10`:'';
  const year=item.original_release_year||item._date?.slice(0,4)||'';
  const runtime=item.runtime?`${item.runtime} min`:'';
  const raw=item.short_description||'';
  const desc=await translateToNL(raw);
  const chips=(item._allProvs||[]).map(p=>{
    const icon=p.icon?`<img src="${p.icon}" alt="">`:'' ;
    return `<span class="svc-chip">${icon}${p.name}</span>`;
  }).join('');
  const watchUrl=item._watchUrl||(item._allProvs||[]).find(p=>p.url)?.url||null;

  si.innerHTML=`
    <div class="sp">${posterBig?`<img src="${posterBig}" alt="">`:''}</div>
    <div class="sinf">
      <div class="ssvc" style="color:${style.color}">${svcName}</div>
      <div class="stitle">${title}</div>
      <div class="smeta">${type==='movie'?'üé¨ Film':'üì∫ Serie'}${year?' ¬∑ '+year:''}${runtime?' ¬∑ '+runtime:''}</div>
      <div class="stags">${genres}</div>
      ${rating?`<div class="srating"><span style="color:#FFD60A">‚òÖ</span> ${rating}</div>`:''}
      ${chips?`<div class="svc-logos">${chips}</div>`:''}
    </div>`;
  sd.textContent=desc||'Geen beschrijving beschikbaar.';
  if(watchUrl){ wb.href=watchUrl; wb.style.display='flex'; }
}

function closeBg(e){
  if(e.target===document.getElementById('overlay')){
    document.getElementById('overlay').classList.remove('open');
    document.body.style.overflow='';
  }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init(){
  try{
    setLoadingText('Streamingdiensten ophalen‚Ä¶');
    await fetchProviders();
    await fetchTitles();
    if(!allItems.length) throw new Error('Geen releases gevonden via JustWatch. Probeer het later opnieuw.');
    buildSvcBar();
    buildDayList();
    renderAll();
  }catch(e){
    console.error(e);
    document.getElementById('main').innerHTML=`
      <div class="error-screen">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-title">Kon releases niet laden</div>
        <div class="error-msg">${e.message||'Controleer je internetverbinding en probeer opnieuw.'}</div>
        <button class="retry-btn" onclick="location.reload()">Opnieuw proberen</button>
      </div>`;
  }
}
init();
</script>

</body>
</html>