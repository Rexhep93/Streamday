<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>StreamDag</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root {
      --bg: #050509;
      --bg2: #080812;
      --card: #11111b;
      --accent: #0a84ff;
      --accent2: #32d74b;
      --t1: #f5f5f7;
      --t2: #a1a1b2;
      --t3: #6b6b7a;
      --border: rgba(255,255,255,0.06);
      --s1: #111118;
      --s2: #181820;
      --s3: #232331;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",system-ui,sans-serif;
      background:radial-gradient(circle at top,#141420 0,#050509 55%);
      color:var(--t1);
      -webkit-font-smoothing:antialiased;
      margin:0;
      padding:0;
    }
    .app{
      min-height:100vh;
      max-width:900px;
      margin:0 auto;
      padding:24px 16px 40px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .logo-wrap{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-dot{
      width:26px;
      height:26px;
      border-radius:9px;
      background:radial-gradient(circle at 30% 20%,#fff 0,rgba(255,255,255,0.35) 40%,transparent 65%),linear-gradient(135deg,#0a84ff,#32d74b);
      box-shadow:0 0 0 0.5px rgba(255,255,255,0.35),0 8px 18px rgba(0,0,0,0.7);
    }
    .title-main{
      font-weight:600;
      letter-spacing:-0.02em;
      font-size:20px;
    }
    .title-sub{
      font-size:12px;
      color:var(--t3);
    }
    .pill-row{
      display:flex;
      gap:8px;
      margin-bottom:12px;
    }
    .pill{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.03);
      color:var(--t2);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:all .18s ease;
    }
    .pill.active{
      border-color:rgba(10,132,255,0.7);
      background:linear-gradient(135deg,rgba(10,132,255,0.2),rgba(50,215,75,0.08));
      color:var(--t1);
      box-shadow:0 0 0 1px rgba(10,132,255,0.3);
    }
    .pill span.icon{
      font-size:14px;
    }
    .origin-filter {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .origin-filter label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--t2);
      cursor: pointer;
    }
    .origin-filter input[type="radio"] {
      width: 16px;
      height: 16px;
    }
    .svc-bar{
      display:flex;
      overflow-x:auto;
      gap:8px;
      padding:6px 2px 6px 0;
      margin-bottom:8px;
      -webkit-overflow-scrolling:touch;
    }
    .svc-bar::-webkit-scrollbar{display:none}
    .sc{
      flex:0 0 auto;
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(15,15,24,0.9);
      border:1px solid rgba(255,255,255,0.06);
      color:var(--t2);
      font-size:11px;
      cursor:pointer;
      transition:all .16s ease;
    }
    .sc img{
      width:16px;
      height:16px;
      border-radius:4px;
      object-fit:cover;
    }
    .sc .dot{
      width:10px;
      height:10px;
      border-radius:999px;
    }
    .sc.active{
      border-color:rgba(10,132,255,0.75);
      background:linear-gradient(135deg,rgba(10,132,255,0.25),rgba(50,215,75,0.12));
      color:var(--t1);
      box-shadow:0 0 0 1px rgba(10,132,255,0.4);
    }
    .loading-screen,.error-screen{
      min-height:50vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      color:var(--t2);
    }
    .spinner{
      width:22px;
      height:22px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,0.08);
      border-top-color:var(--accent);
      animation:spin 0.8s linear infinite;
      margin-bottom:14px;
    }
    .loading-text{
      font-size:14px;
    }
    .error-icon{
      font-size:32px;
      margin-bottom:10px;
    }
    .error-title{
      font-weight:600;
      margin-bottom:4px;
    }
    .error-msg{
      font-size:13px;
      color:var(--t3);
      max-width:260px;
      margin:0 auto 14px;
    }
    .retry-btn{
      border:none;
      outline:none;
      padding:8px 16px;
      border-radius:999px;
      background:var(--accent);
      color:#fff;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(10,132,255,0.6);
    }
    .day-section{
      margin-top:18px;
      padding:16px 12px 18px;
      border-radius:18px;
      background:linear-gradient(145deg,rgba(17,17,26,0.96),rgba(8,8,14,0.98));
      border:1px solid rgba(255,255,255,0.04);
      box-shadow:0 16px 35px rgba(0,0,0,0.75);
      animation:fadeUp .35s ease forwards;
      opacity:0;
      transform:translateY(8px);
    }
    .day-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:2px;
    }
    .day-name{
      font-size:14px;
      font-weight:600;
      letter-spacing:0.01em;
    }
    .today-chip{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(10,132,255,0.15);
      color:var(--accent);
      border:1px solid rgba(10,132,255,0.55);
    }
    .day-sub{
      font-size:12px;
      color:var(--t3);
      margin-bottom:8px;
    }
    .cat-row{
      font-size:12px;
      color:var(--t2);
      margin:10px 0 6px;
    }
    .scroll-track{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding-bottom:4px;
      margin-bottom:6px;
      -webkit-overflow-scrolling:touch;
    }
    .scroll-track::-webkit-scrollbar{height:0}
    .card{
      flex:0 0 142px;
      background:var(--card);
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.06);
      padding:6px 6px 10px;
      cursor:pointer;
      transition:transform .16s ease,box-shadow .16s ease,background .16s ease,border-color .16s ease;
      box-shadow:0 10px 22px rgba(0,0,0,0.7);
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 16px 30px rgba(0,0,0,0.9);
      border-color:rgba(10,132,255,0.5);
      background:radial-gradient(circle at top,rgba(10,132,255,0.16),var(--card));
    }
    .card-poster{
      position:relative;
      border-radius:12px;
      overflow:hidden;
      background:var(--s3);
      margin-bottom:6px;
      aspect-ratio:2/3;
    }
    .card-poster img.poster{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      background:#000;
    }
    .fallback{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px;
      color:var(--t2);
      font-size:11px;
      text-align:center;
    }
    .new-label{
      position:absolute;
      top:6px;
      left:6px;
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(50,215,75,0.92);
      color:#000;
      font-weight:600;
    }
    .badge{
      position:absolute;
      bottom:6px;
      left:6px;
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      max-width:70%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      backdrop-filter:blur(12px);
    }
    .card-title{
      font-size:12px;
      font-weight:500;
      line-height:1.2;
      margin-bottom:2px;
      max-height:2.4em;
      overflow:hidden;
    }
    .card-meta{
      font-size:11px;
      color:var(--t3);
    }
    .origin-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 6px;
      margin-left: 6px;
      border: 1px solid;
    }
    .origin-badge.original {
      background: rgba(50,215,75,0.2);
      color: #32d74b;
      border-color: rgba(50,215,75,0.4);
    }
    .origin-badge.licensed {
      background: rgba(255,193,7,0.2);
      color: #f6c23e;
      border-color: rgba(255,193,7,0.4);
    }
    .divider{
      margin-top:10px;
      height:1px;
      background:linear-gradient(to right,rgba(255,255,255,0.12),rgba(255,255,255,0.02));
    }
    #overlay{
      position:fixed;
      inset:0;
      background:rgba(3,3,8,0.88);
      backdrop-filter:blur(20px);
      -webkit-backdrop-filter:blur(20px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:20;
    }
    #overlay.open{display:flex;}
    .sheet{
      width:100%;
      max-width:640px;
      border-radius:22px 22px 0 0;
      background:linear-gradient(160deg,#101018,#06060d);
      padding:14px 16px 18px;
      border:1px solid rgba(255,255,255,0.08);
      border-bottom:none;
      box-shadow:0 -18px 40px rgba(0,0,0,0.95);
      max-height:85vh;
      display:flex;
      flex-direction:column;
      animation:slideUp .28s ease-out;
    }
    .drag{
      width:36px;
      height:4px;
      border-radius:999px;
      background:rgba(255,255,255,0.2);
      margin:0 auto 8px;
    }
    .sheet-header{
      display:flex;
      gap:12px;
      margin-bottom:10px;
    }
    .sp{
      width:84px;
      height:126px;
      border-radius:14px;
      overflow:hidden;
      background:var(--s3);
      flex-shrink:0;
    }
    .sp img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .sinf{
      flex:1;
      min-width:0;
    }
    .ssvc{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--t2);
      margin-bottom:3px;
    }
    .stitle{
      font-size:16px;
      font-weight:600;
      margin-bottom:2px;
    }
    .smeta{
      font-size:12px;
      color:var(--t3);
      margin-bottom:4px;
    }
    .stags{
      font-size:11px;
      margin-bottom:4px;
    }
    .stag{
      display:inline-block;
      padding:2px 7px;
      border-radius:999px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.14);
      margin-right:4px;
      margin-bottom:3px;
    }
    .srating{
      font-size:12px;
      color:var(--t2);
    }
    .sheet-body{
      font-size:13px;
      color:var(--t2);
      line-height:1.4;
      overflow:auto;
      padding-right:2px;
      margin-bottom:8px;
    }
    .watch-btn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:9px 14px;
      border-radius:999px;
      border:none;
      outline:none;
      background:linear-gradient(135deg,#0a84ff,#32d74b);
      color:#fff;
      font-size:14px;
      font-weight:600;
      text-decoration:none;
      margin-top:4px;
      box-shadow:0 8px 22px rgba(10,132,255,0.8);
      cursor: pointer;
    }
    .watch-btn span{
      font-size:14px;
    }

    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    @media (min-width:768px){
      .app{padding-top:28px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo-wrap">
        <div class="logo-dot"></div>
        <div>
          <div class="title-main">StreamDag</div>
          <div class="title-sub">Wat is nieuw op streaming vandaag</div>
        </div>
      </div>
    </header>

    <div class="pill-row">
      <div class="pill active" data-f="all" onclick="setType(this)">
        <span class="icon">‚óé</span>Alles
      </div>
      <div class="pill" data-f="movie" onclick="setType(this)">
        <span class="icon">üé¨</span>Films
      </div>
      <div class="pill" data-f="tv" onclick="setType(this)">
        <span class="icon">üì∫</span>Series
      </div>
    </div>

    <div class="origin-filter">
      <label>
        <input type="radio" name="originType" value="all" checked onchange="setOriginFilter(this)">
        <span>Alles</span>
      </label>
      <label>
        <input type="radio" name="originType" value="original" onchange="setOriginFilter(this)">
        <span>Origineel</span>
      </label>
      <label>
        <input type="radio" name="originType" value="licensed" onchange="setOriginFilter(this)">
        <span>Gelicenseerd</span>
      </label>
    </div>

    <div id="svcBar" class="svc-bar"></div>

    <main id="main">
      <div class="loading-screen">
        <div class="spinner"></div>
        <div class="loading-text">Laden van vandaag's releases‚Ä¶</div>
      </div>
    </main>
  </div>

  <!-- Detail sheet -->
  <div id="overlay" onclick="closeBg(event)">
    <div class="sheet">
      <div class="drag"></div>
      <div class="sheet-header">
        <div id="si" class="si"></div>
      </div>
      <div id="sd" class="sheet-body"></div>
      <a id="wb" class="watch-btn" href="#" target="_blank" rel="noopener noreferrer" style="display:none">
        <span>‚ñ∂</span> Nu kijken
      </a>
    </div>
  </div>

<script>
const API_KEY = 'eLLuTN9mYhAAWBNl1P3XOGgRKFA1toAVWhOiYX3m';
const WM      = 'https://api.watchmode.com/v1';

// Alleen NL streaming services
const NL_STREAMING_SERVICES = [
  'netflix', 'prime', 'amazon', 'disney', 'apple', 'appletv', 'max', 
  'hbo', 'videoland', 'path√©-thuis', 'path√©'
];

// Colours for service badges
const SVC_COLORS = {
  'netflix':      { color:'#E50914', text:'#fff' },
  'prime':        { color:'#00A8E0', text:'#fff' },
  'amazon':       { color:'#00A8E0', text:'#fff' },
  'disney':       { color:'#113CCF', text:'#fff' },
  'apple':        { color:'#555',    text:'#fff' },
  'appletv':      { color:'#555',    text:'#fff' },
  'max':          { color:'#5822B4', text:'#fff' },
  'hbo':          { color:'#5822B4', text:'#fff' },
  'videoland':    { color:'#E00000', text:'#fff' },
  'path√©-thuis':  { color:'#FF6B00', text:'#fff' },
  'path√©':        { color:'#FF6B00', text:'#fff' },
  'default':      { color:'#444',    text:'#fff' },
};

function getSvcStyle(name='') {
  const lower = name.toLowerCase();
  const key = Object.keys(SVC_COLORS).find(k => lower.includes(k));
  return SVC_COLORS[key] || SVC_COLORS.default;
}

function isStreamingService(sourceName) {
  const lower = (sourceName || '').toLowerCase();
  return NL_STREAMING_SERVICES.some(svc => lower.includes(svc));
}

function determineOriginType(item, source) {
  const sourceName = (source.name || '').toLowerCase();
  const title = (item.title || '').toLowerCase();
  
  // Betere detectie voor originele content
  const originalIndicators = [
    'original', 'netflix original', 'disney+ original', 'hbomax original',
    'max original', 'exclusief', 'eigen productie', 'season'
  ];
  
  const isOriginal = originalIndicators.some(indicator => 
    title.includes(indicator) || sourceName.includes(indicator)
  ) || 
  ['netflix', 'disney', 'max', 'hbo', 'videoland'].some(svc => sourceName.includes(svc));
  
  return isOriginal ? 'original' : 'licensed';
}

// STATE
let sources    = [];
let allItems   = [];
let typeFilter = 'all';
let svcFilter  = 'all';
let originFilter = 'all';
const detailCache = {};

// Helpers
function dateStr(offset=0){
  const d = new Date();
  d.setDate(d.getDate() + offset);
  return d.toISOString().slice(0,10).replace(/-/g,'');
}
function isoDate(wmDate){
  if(!wmDate) return '';
  const s = String(wmDate);
  if(s.includes('-')) return s.slice(0,10);
  return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
}
function todayISO(){
  return new Date().toISOString().slice(0,10);
}
function dayName(iso){
  const d = new Date(iso + 'T12:00:00');
  return d.toLocaleDateString('nl-NL',{weekday:'long'});
}
function fullDate(iso){
  const d = new Date(iso + 'T12:00:00');
  return d.toLocaleDateString('nl-NL',{day:'numeric',month:'long',year:'numeric'});
}

async function wm(path, params={}){
  const url = new URL(WM + path);
  url.searchParams.set('apiKey', API_KEY);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
  const r = await fetch(url.toString());
  if(!r.ok) throw new Error(`Watchmode ${r.status}: ${await r.text()}`);
  return r.json();
}

// 1. Get NL streaming sources only
async function fetchSources(){
  const data = await wm('/sources', { regions:'NL' });
  sources = (Array.isArray(data) ? data : [])
    .filter(s => s.type === 'sub' && s.regions && s.regions.includes('NL'))
    .filter(s => isStreamingService(s.name))
    .sort((a,b) => (a.name||'').localeCompare(b.name||''));
  return sources;
}

// 2. Fetch releases - FIX: betere type categorisatie
async function fetchReleases(){
  const fromDate = dateStr(-14);
  const toDate   = dateStr(14);

  const [moviesRes, tvRes] = await Promise.all([
    wm('/releases', {
      regions:'NL',
      start_date: fromDate,
      end_date:   toDate,
      types: 'movie',
      limit: 250,
    }),
    wm('/releases', {
      regions:'NL',
      start_date: fromDate,
      end_date:   toDate,
      types: 'tv_series,tv_miniseries,tv_special',
      limit: 250,
    }),
  ]);

  function parseItems(res, typeLabel){
    const list = res && Array.isArray(res.releases) ? res.releases : [];
    
    return list.map(item => {
      const src = sources.find(s => s.id === item.source_id) || {};
      if (!isStreamingService(src.name || item.source_name)) return null;
      
      // FIX: Betere type detectie voor series vs films
      let finalType = typeLabel;
      const titleLower = (item.title || '').toLowerCase();
      
      // Herken series beter
      if (typeLabel === 'movie' && (
        titleLower.includes('season') || 
        titleLower.includes('seizoen') ||
        titleLower.includes('aflevering') ||
        titleLower.includes('episode')
      )) {
        finalType = 'tv';
      }
      
      const style = getSvcStyle(src.name || item.source_name || '');
      const originType = determineOriginType(item, src);
      
      return {
        ...item,
        img: item.poster_url || null,
        _type: finalType,
        _date: isoDate(item.source_release_date),
        _src: src.id ? src : { name:item.source_name || 'Streaming' },
        _style: style,
        _originType: originType
      };
    }).filter(Boolean);
  }

  const movies = parseItems(moviesRes, 'movie');
  const tv     = parseItems(tvRes, 'tv');
  allItems     = [...movies, ...tv];

  // Duplicaten verwijderen
  const seen = new Set();
  allItems = allItems.filter(item => {
    const key = `${item.id}-${item.source_id}`;
    if(seen.has(key)) return false;
    seen.add(key);
    return !!item._date;
  });
}

// Grouped by date - met betere filtering
function grouped(){
  const map = {};
  const filtered = allItems.filter(item => {
    // Type filter
    if(typeFilter === 'movie' && item._type !== 'movie') return false;
    if(typeFilter === 'tv' && item._type !== 'tv') return false;
    
    // Service filter
    if(svcFilter !== 'all' && String(item.source_id) !== String(svcFilter)) return false;
    
    // Origin filter
    if(originFilter !== 'all' && item._originType !== originFilter) return false;
    
    return !!item._date;
  });
  
  filtered.forEach(item => {
    if(!map[item._date]) map[item._date] = { movies:[], tv:[] };
    if(item._type === 'movie') map[item._date].movies.push(item);
    else map[item._date].tv.push(item);
  });
  return map;
}

// Render
function renderAll(){
  const main = document.getElementById('main');
  main.innerHTML = '';

  const g = grouped();
  const today = todayISO();

  const days = Array.from({length:14},(_,i)=>{
    const d = new Date();
    d.setDate(d.getDate()+i-3);
    return d.toISOString().slice(0,10);
  });

  let count = 0;

  days.forEach(iso => {
    const data = g[iso];
    if(!data) return;
    const movies = data.movies || [];
    const tv     = data.tv || [];
    if(!movies.length && !tv.length) return;
    count++;

    const sec = document.createElement('section');
    sec.className = 'day-section';
    sec.style.animationDelay = `${count * 0.04}s`;

    const chip = iso === today ? '<span class="today-chip">Vandaag</span>' : '';
    let html = `
      <div class="day-header">
        <div class="day-name">${dayName(iso)}</div>
        ${chip}
      </div>
      <div class="day-sub">${fullDate(iso)}</div>
    `;

    if(movies.length){
      html += `<div class="cat-row">üé¨ &nbsp;Films (${movies.length})</div>
               <div class="scroll-track">${movies.map(card).join('')}</div>`;
    }
    if(tv.length){
      html += `<div class="cat-row">üì∫ &nbsp;Series (${tv.length})</div>
               <div class="scroll-track">${tv.map(card).join('')}</div>`;
    }

    html += '<div class="divider"></div>';
    sec.innerHTML = html;
    main.appendChild(sec);
  });

  if(!count){
    main.innerHTML = `
      <div class="loading-screen">
        <div class="loading-text">Geen nieuwe releases gevonden.</div>
      </div>`;
  }
}

function card(item){
  const title = (item.title || '').replace(/'/g,"&#39;").replace(/"/g,'&quot;');
  const style = item._style;
  const svcName = (item._src.name || item.source_name || 'Streaming').replace(/Netherlands/i,'').trim();
  
  const originClass = item._originType === 'original' ? 'original' : 'licensed';
  const originText = item._originType === 'original' ? 'Origineel' : 'Gelicenseerd';

  const imgEl = item.img
    ? `<img class="poster" src="${item.img}" alt="${title}" loading="lazy"
       onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`
    : '';

  const fallbackDisplay = item.img ? 'none' : 'flex';
  const rating = item.user_rating ? `‚≠ê ${(item.user_rating/10).toFixed(1)}` :
                   (item._type === 'movie' ? 'Film' : 'Serie');

  return `
    <div class="card" onclick="openModal(${item.id || 0},'${item._type}','${(item.watchmode_id||item.id||0)}')">
      <div class="card-poster">
        ${imgEl}
        <div class="fallback" style="display:${fallbackDisplay}"><span>${title}</span></div>
        <div class="new-label">Nieuw</div>
        <div class="badge" style="background:${style.color}dd;color:${style.text}">${svcName}</div>
      </div>
      <div class="card-title">${title}</div>
      <div class="card-meta">
        ${rating} 
        <span class="origin-badge ${originClass}">${originText}</span>
      </div>
    </div>
  `;
}

// Service bar
function buildSvcBar(){
  const foundIds = new Set(allItems.map(i => String(i.source_id)));
  const bar = document.getElementById('svcBar');
  bar.innerHTML = `<div class="sc active" data-id="all" onclick="setSvc(this)">Alle diensten</div>`;

  sources
    .filter(s => foundIds.has(String(s.id)))
    .forEach(s => {
      const style = getSvcStyle(s.name || '');
      const name  = (s.name || '').replace(/Netherlands/i,'').trim();
      const logo  = s.logo_100px
        ? `<img src="${s.logo_100px}" alt="">`
        : `<div class="dot" style="background:${style.color}"></div>`;
      bar.innerHTML += `<div class="sc" data-id="${s.id}" onclick="setSvc(this)">${logo}${name}</div>`;
    });
}

// Filters
function setOriginFilter(el) {
  originFilter = el.value;
  renderAll();
}

function setType(el){
  typeFilter = el.dataset.f;
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  renderAll();
}

function setSvc(el){
  svcFilter = el.dataset.id;
  document.querySelectorAll('.sc').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  renderAll();
}

// Modal
async function openModal(id,type,wmId){
  const overlay = document.getElementById('overlay');
  const si = document.getElementById('si');
  const sd = document.getElementById('sd');
  const wb = document.getElementById('wb');

  const item = allItems.find(i => (i.id===id||i.watchmode_id===id) && i._type===type)
           || allItems.find(i => String(i.watchmode_id||i.id)===String(wmId));

  const title  = item?.title || '‚Äî';
  const poster = item?.img || '';
  const svcName = (item?._src?.name||item?.source_name||'Streaming').replace(/Netherlands/i,'').trim();
  const style  = item?._style || getSvcStyle('');
  const originType = item?._originType || '';

  si.innerHTML = `
    <div class="sp">${poster ? `<img src="${poster}" alt="">` : `<div class="fallback"><span>${title}</span></div>`}</div>
    <div class="sinf">
      <div class="ssvc" style="color:${style.color}">${svcName}</div>
      <div class="stitle">${title}</div>
      <div class="smeta">${type==='movie'?'üé¨ Film':'üì∫ Serie'}</div>
      <div style="color:var(--t3);font-size:12px">Details laden‚Ä¶</div>
    </div>`;
  sd.textContent = '';
  wb.style.display = 'none';
  overlay.classList.add('open');
  document.body.style.overflow = 'hidden';

  const key = String(wmId || id);
  if(!detailCache[key] && key!=='0'){
    try{
      const d = await wm(`/title/${key}/details`);
      detailCache[key] = d;
    }catch(e){
      detailCache[key] = null;
    }
  }

  const d = detailCache[key];
  const fullTitle  = d?.title  || title;
  const overview   = d?.plot_overview || item?.overview || 'Geen beschrijving beschikbaar.';
  const year       = d?.year || (item?._date||'').slice(0,4);
  const runtime    = d?.runtime_minutes ? `${d.runtime_minutes} min` : '';
  const rating     = d?.user_rating ? `${(d.user_rating/10).toFixed(1)} / 10` : '';
  const genres     = (d?.genres||[]).slice(0,3).map(g=>`<span class="stag">${g.name||g}</span>`).join('');
  const posterUrl  = d?.poster || item?.img || '';

  let watchLink = null;
  if(d?.sources){
    const nlSrc = d.sources.find(s => s.region==='NL' && s.type==='sub');
    const usSrc = d.sources.find(s => s.region==='US' && s.type==='sub');
    watchLink = nlSrc?.web_url || usSrc?.web_url || null;
  }

  const originBadge = originType === 'original' 
    ? '<div class="origin-badge original">Originele content</div>'
    : '<div class="origin-badge licensed">Gelicenseerde content</div>';

  si.innerHTML = `
    <div class="sp">${posterUrl ? `<img src="${posterUrl}" alt="">` : `<div class="fallback"><span>${fullTitle}</span></div>`}</div>
    <div class="sinf">
      <div class="ssvc" style="color:${style.color}">${svcName}</div>
      <div class="stitle">${fullTitle}</div>
      <div class="smeta">${type==='movie'?'üé¨ Film':'üì∫ Serie'}${year?' ¬∑ '+year:''}${runtime?' ¬∑ '+runtime:''}</div>
      <div class="stags">${genres}</div>
      ${rating?`<div class="srating"><span style="color:#FFD60A">‚òÖ</span> ${rating}</div>`:''}
      ${originBadge}
    </div>`;
  sd.textContent = overview;

  if(watchLink){ 
    wb.href = watchLink; 
    wb.style.display = 'flex';
  }
}

function closeBg(e){
  if(e.target === document.getElementById('overlay')){
    document.getElementById('overlay').classList.remove('open');
    document.body.style.overflow = '';
  }
}

// Init
async function init(){
  try{
    document.querySelector('.loading-text').textContent = 'Bezig met ophalen streamingdiensten‚Ä¶';
    await fetchSources();
    if(!sources.length) throw new Error('Geen streamingdiensten gevonden voor Nederland.');

    document.querySelector('.loading-text').textContent = `Laden releases van ${sources.length} diensten‚Ä¶`;
    await fetchReleases();

    buildSvcBar();
    renderAll();
  }catch(e){
    console.error(e);
    document.getElementById('main').innerHTML = `
      <div class="error-screen">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-title">Kon releases niet laden</div>
        <div class="error-msg">${e.message || 'Er ging iets mis. Controleer je internetverbinding.'}</div>
        <button class="retry-btn" onclick="location.reload()">Opnieuw proberen</button>
      </div>`;
  }
}

init();
</script>
</body>
</html>
