<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>StreamGids</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <!-- PWA / iOS homescreen -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="StreamGids" />
  <meta name="theme-color" content="#050509" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%231a2240'/%3E%3Cstop offset='100%25' stop-color='%230d1525'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='200' height='200' rx='42' fill='url(%23g)'/%3E%3Crect x='136' y='24' width='32' height='32' rx='6' fill='%23E8001A'/%3E%3Ctext x='100' y='116' text-anchor='middle' dominant-baseline='middle' font-family='-apple-system,BlinkMacSystemFont,%22SF Pro Display%22,%22Helvetica Neue%22,Arial,sans-serif' font-size='118' font-weight='800' fill='white' letter-spacing='-6'%3ESG%3C/text%3E%3C/svg%3E" />
  <style>
    :root {
      --bg: #050509; --card: #11111b; --accent: #0a84ff; --accent2: #32d74b;
      --t1: #f5f5f7; --t2: #a1a1b2; --t3: #6b6b7a; --s3: #232331;
    }
    body[data-theme="light"] {
      --bg: #f0f0f5; --card: #ffffff; --accent: #0a84ff; --accent2: #28a745;
      --t1: #1c1c1e; --t2: #3a3a3c; --t3: #8e8e93; --s3: #e0e0ea;
      background: radial-gradient(circle at top, #d8d8f0 0, #f0f0f5 55%) !important;
    }
    body[data-theme="light"] .day-section {
      background: linear-gradient(145deg, rgba(255,255,255,0.97), rgba(240,240,248,0.98));
      border-color: rgba(0,0,0,0.06);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    body[data-theme="light"] .sheet {
      background: linear-gradient(160deg, #f8f8fc, #eeeef5);
      border-color: rgba(0,0,0,0.08);
    }
    body[data-theme="light"] #overlay {
      background: rgba(180,180,210,0.80);
    }
    body[data-theme="light"] .card {
      border-color: rgba(0,0,0,0.08);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    body[data-theme="light"] .pill,
    body[data-theme="light"] .sc,
    body[data-theme="light"] .nav-btn {
      border-color: rgba(0,0,0,0.1);
      background: rgba(0,0,0,0.03);
      color: var(--t2);
    }
    body[data-theme="light"] .pill.active,
    body[data-theme="light"] .sc.active {
      background: linear-gradient(135deg,rgba(10,132,255,0.15),rgba(50,215,75,0.06));
      border-color: rgba(10,132,255,0.5);
      color: var(--accent);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      background:radial-gradient(circle at top,#141420 0,#050509 55%);
      color:var(--t1); -webkit-font-smoothing:antialiased;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .app{ min-height:100vh; max-width:900px; margin:0 auto; padding:env(safe-area-inset-top, 24px) 16px 40px; padding-top: max(24px, env(safe-area-inset-top)); }
    header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; }
    .logo-wrap{ display:flex; align-items:center; gap:10px; }
    .logo-wrap svg { display:block; }

    .source-pills{ display:none; gap:6px; margin-bottom:10px; }
    .source-pill{
      font-size:10px; padding:3px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.1); color:var(--t3);
      background:rgba(255,255,255,0.03);
    }
    .source-pill.wm{ border-color:rgba(10,132,255,0.4); color:var(--accent); background:rgba(10,132,255,0.08); }
    .source-pill.tmdb{ border-color:rgba(50,215,75,0.4); color:var(--accent2); background:rgba(50,215,75,0.08); }

    .pill-row{
      display:flex; gap:8px; margin-bottom:12px;
      flex-wrap:nowrap; overflow-x:auto; padding-bottom:4px;
      -webkit-overflow-scrolling:touch;
    }
    .pill-row::-webkit-scrollbar{display:none}
    .pill{
      padding:6px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.03);
      color:var(--t2); font-size:12px;
      display:flex; align-items:center; gap:6px;
      cursor:pointer; transition:all .18s ease;
      font-family:inherit;
    }
    .icon-btn {
      display:flex; align-items:center; justify-content:center;
      width:34px; height:34px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(255,255,255,0.04);
      color:var(--t2); font-size:16px;
      cursor:pointer; transition:all .16s ease;
      font-family:inherit;
    }
    .icon-btn:hover { border-color:rgba(10,132,255,0.5); color:var(--t1); }
    [data-theme="light"] .icon-btn { border-color:rgba(0,0,0,0.12); background:rgba(0,0,0,0.04); }

    .theme-btn {
      display:flex; align-items:center; justify-content:center;
      padding:6px 14px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.2);
      background:rgba(255,255,255,0.08);
      color:var(--t1); font-size:12px; font-weight:500;
      cursor:pointer; transition:all .16s ease;
      font-family:inherit;
      min-width:72px; text-align:center;
    }
    .theme-btn:hover { border-color:rgba(10,132,255,0.5); }
    [data-theme="light"] .theme-btn {
      border-color:rgba(0,0,0,0.12);
      background:rgba(0,0,0,0.04);
      color:var(--t2);
    }
    .header-actions { display:flex; align-items:center; gap:8px; }
    .fav-btn {
      position:absolute; top:6px; right:28px;
      width:22px; height:22px; border-radius:999px;
      background:rgba(0,0,0,0.5); border:none;
      color:#fff; font-size:12px; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      backdrop-filter:blur(8px); transition:transform .15s ease;
    }
    .fav-btn.active { color:#FFD60A; }
    .fav-btn:hover { transform:scale(1.2); }
    .share-btn {
      display:flex; align-items:center; justify-content:center; gap:6px;
      padding:9px 14px; border-radius:999px; border:1px solid rgba(255,255,255,0.15);
      background:rgba(255,255,255,0.06);
      color:var(--t1); font-size:13px; font-weight:500;
      cursor:pointer; margin-top:8px; width:100%;
      font-family:inherit; transition:all .16s ease;
    }
    .share-btn:hover { background:rgba(255,255,255,0.1); }
    [data-theme="light"] .share-btn { border-color:rgba(0,0,0,0.12); background:rgba(0,0,0,0.04); color:var(--t1); }
    .pill.active{
      border-color:rgba(10,132,255,0.7);
      background:linear-gradient(135deg,rgba(10,132,255,0.2),rgba(50,215,75,0.08));
      color:var(--t1); box-shadow:0 0 0 1px rgba(10,132,255,0.3);
    }

    .svc-bar{
      display:flex; overflow-x:auto;
      gap:8px; padding:6px 2px 6px 0;
      margin-bottom:8px; -webkit-overflow-scrolling:touch;
    }
    .svc-bar::-webkit-scrollbar{display:none}
    .sc{
      flex:0 0 auto; display:flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      background:rgba(15,15,24,0.9);
      border:1px solid rgba(255,255,255,0.06);
      color:var(--t2); font-size:11px; cursor:pointer;
      transition:all .16s ease; white-space:nowrap;
      font-family:inherit;
    }
    .sc img{ width:16px; height:16px; border-radius:4px; object-fit:cover; }
    .sc .dot{ width:10px; height:10px; border-radius:999px; flex-shrink:0; }
    .sc.active{
      border-color:rgba(10,132,255,0.75);
      background:linear-gradient(135deg,rgba(10,132,255,0.25),rgba(50,215,75,0.12));
      color:var(--t1); box-shadow:0 0 0 1px rgba(10,132,255,0.4);
    }

    .nav-bar{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:8px; gap:8px;
    }
    .nav-btn{
      display:flex; align-items:center; gap:6px;
      padding:8px 14px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(255,255,255,0.04);
      color:var(--t2); font-size:12px; font-weight:500;
      cursor:pointer; transition:all .16s ease; white-space:nowrap;
      font-family:inherit;
    }
    .nav-btn:hover:not(:disabled){ border-color:rgba(10,132,255,0.5); color:var(--t1); }
    .nav-btn:disabled{ opacity:0.3; cursor:default; pointer-events:none; }
    .nav-range{ font-size:12px; color:var(--t3); text-align:center; flex:1; }

    .loading-screen,.error-screen{
      min-height:50vh; display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      text-align:center; color:var(--t2);
    }
    .spinner{
      width:22px; height:22px; border-radius:999px;
      border:2px solid rgba(255,255,255,0.08);
      border-top-color:var(--accent);
      animation:spin 0.8s linear infinite; margin-bottom:14px;
    }
    .loading-text{ font-size:14px; }
    .loading-sub{ font-size:12px; color:var(--t3); margin-top:6px; }
    .error-icon{ font-size:32px; margin-bottom:10px; }
    .error-title{ font-weight:600; margin-bottom:4px; }
    .error-msg{ font-size:13px; color:var(--t3); max-width:260px; margin:0 auto 14px; }
    .retry-btn{
      border:none; outline:none; padding:8px 16px; border-radius:999px;
      background:var(--accent); color:#fff; font-size:13px;
      font-weight:500; cursor:pointer;
      box-shadow:0 6px 16px rgba(10,132,255,0.6);
    }

    .day-section{
      margin-top:18px; padding:16px 12px 18px;
      border-radius:18px;
      background:linear-gradient(145deg,rgba(17,17,26,0.96),rgba(8,8,14,0.98));
      border:1px solid rgba(255,255,255,0.04);
      box-shadow:0 16px 35px rgba(0,0,0,0.75);
      animation:fadeUp .35s ease forwards;
      opacity:0; transform:translateY(8px);
    }
    .day-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:2px; }
    .day-name{ font-size:14px; font-weight:600; letter-spacing:0.01em; }
    .today-chip{
      font-size:11px; padding:3px 8px;
      background: #30af4c;
      color: #fff;
  	  font-weight: 700;
    }
    .day-sub{ font-size:12px; color:var(--t3); margin-bottom:8px; }
    .cat-row{ font-size:12px; color: #fff; margin:10px 0 6px; }

    .scroll-track{
      display:flex; gap:10px; overflow-x:auto;
      padding-bottom:4px; margin-bottom:6px;
      -webkit-overflow-scrolling:touch;
    }
    .scroll-track::-webkit-scrollbar{height:0}

    .card{
      flex:0 0 142px; background:var(--card);
      border-radius:16px; border:1px solid rgba(255,255,255,0.06);
      padding:6px 6px 10px; cursor:pointer;
      transition:transform .16s ease,box-shadow .16s ease,background .16s ease,border-color .16s ease;
      box-shadow:0 10px 22px rgba(0,0,0,0.7);
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 16px 30px rgba(0,0,0,0.9);
      border-color:rgba(10,132,255,0.5);
      background:radial-gradient(circle at top,rgba(10,132,255,0.16),var(--card));
    }
    .card-poster{
      position:relative; border-radius:12px; overflow:hidden;
      background:var(--s3); margin-bottom:6px; aspect-ratio:2/3;
    }
    .card-poster img.poster{ width:100%; height:100%; object-fit:cover; display:block; background:#000; }
    .fallback{
      position:absolute; inset:0; display:flex;
      align-items:center; justify-content:center;
      padding:8px; color:var(--t2); font-size:11px; text-align:center;
    }
    .new-label{
      position:absolute; top:6px; left:6px; font-size:10px;
      padding:2px 6px; border-radius:999px;
      background:rgba(50,215,75,0.92); color:#000; font-weight:600;
    }
    .badge{
      position:absolute; bottom:6px; left:6px; font-size:10px;
      padding:2px 6px; border-radius:999px;
      display:inline-flex; align-items:center;
      max-width:calc(100% - 12px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      backdrop-filter:blur(12px);
    }
    .src-dot{
      position:absolute; top:6px; right:6px; width:6px; height:6px; border-radius:999px;
    }
    .season-badge{
      position:absolute; top:6px; right:16px;
      font-size:10px; font-weight:700;
      padding:2px 6px; border-radius:999px;
      background:rgba(0,0,0,0.72); color:#fff;
      backdrop-filter:blur(8px);
      border:1px solid rgba(255,255,255,0.2);
    }
    .card-title{
      font-size:12px; font-weight:500; line-height:1.2;
      margin-bottom:2px; max-height:2.4em; overflow:hidden;
    }
    .card-meta{ font-size:11px; color:var(--t3); }
    .origin-badge{
      font-size:10px; padding:2px 6px; border-radius:6px;
      margin-left:6px; border:1px solid;
    }
    .origin-badge.original{ background:rgba(50,215,75,0.2); color:#32d74b; border-color:rgba(50,215,75,0.4); }
    .origin-badge.licensed{ background:rgba(255,193,7,0.2); color:#f6c23e; border-color:rgba(255,193,7,0.4); }
    .divider{ margin-top:10px; height:1px; background:linear-gradient(to right,rgba(255,255,255,0.12),rgba(255,255,255,0.02)); }
    .empty-day{ font-size:13px; color:var(--t3); padding:8px 0; }

    #overlay{
      position:fixed; inset:0;
      background:rgba(3,3,8,0.88);
      backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
      display:none; align-items:flex-end; justify-content:center; z-index:20;
    }
    #overlay.open{display:flex;}
    .sheet-header{ display:flex; gap:12px; margin-bottom:10px; }
    .sp{ width:84px; height:126px; border-radius:14px; overflow:hidden; background:var(--s3); flex-shrink:0; }
    .sp img{ width:100%; height:100%; object-fit:cover; }
    .sinf{ flex:1; min-width:0; }
    .ssvc{ font-size:11px; text-transform:uppercase; letter-spacing:0.08em; color:var(--t2); margin-bottom:3px; }
    .stitle{ font-size:16px; font-weight:600; margin-bottom:2px; }
    .smeta{ font-size:12px; color:var(--t3); margin-bottom:4px; }
    .stags{ font-size:11px; margin-bottom:4px; }
    .stag{ display:inline-block; padding:2px 7px; border-radius:999px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.14); margin-right:4px; margin-bottom:3px; }
    .srating{ font-size:12px; color:var(--t2); }
    .sheet-body{ font-size:13px; color:var(--t2); line-height:1.6; overflow:auto; padding-right:2px; margin-bottom:8px; }
    .sheet{
      width:100%; max-width:640px;
      border-radius:22px 22px 0 0;
      background:linear-gradient(160deg,#101018,#06060d);
      padding:14px 16px calc(18px + env(safe-area-inset-bottom, 0px));
      border:1px solid rgba(255,255,255,0.08); border-bottom:none;
      box-shadow:0 -18px 40px rgba(0,0,0,0.95);
      max-height:88vh; display:flex; flex-direction:column;
      animation:slideUp .28s ease-out;
    }
    .drag{ width:36px; height:4px; border-radius:999px; background:rgba(255,255,255,0.2); margin:0 auto 8px; }
    body[data-theme="light"] .drag { background: rgba(0,0,0,0.15); }
    .watch-btn{
      width:100%; display:flex; align-items:center; justify-content:center; gap:6px;
      padding:9px 14px; border-radius:999px; border:none; outline:none;
      background:linear-gradient(135deg,#0a84ff,#32d74b);
      color:#fff; font-size:14px; font-weight:600;
      text-decoration:none; margin-top:4px;
      box-shadow:0 8px 22px rgba(10,132,255,0.8); cursor:pointer;
    }

    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    @media(min-width:768px){.app{padding-top:28px}}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo-wrap">
      <!-- SG App Icon SVG -->
      <svg width="34" height="34" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;border-radius:14px;overflow:hidden">
        <defs>
          <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#1a2240"/>
            <stop offset="100%" style="stop-color:#0d1525"/>
          </linearGradient>
        </defs>
        <rect width="200" height="200" rx="42" fill="url(#bgGrad)"/>
        <!-- Red square accent top-right (kleiner) -->
        <rect x="138" y="26" width="30" height="30" rx="6" fill="#E8001A"/>
        <!-- SG letters (iets kleiner, volledig zichtbaar) -->
        <text x="100" y="116" text-anchor="middle" dominant-baseline="middle"
              font-family="-apple-system,BlinkMacSystemFont,'SF Pro Display','Helvetica Neue',Arial,sans-serif"
              font-size="120" font-weight="800" fill="white" letter-spacing="-6">SG</text>
      </svg>
      <!-- StreamGids NL text logo SVG -->
      <svg width="190" height="34" viewBox="0 0 320 64" xmlns="http://www.w3.org/2000/svg">
      <!-- Stream en Gids dichter bij elkaar -->
        <text x="0" y="46" font-family="-apple-system,BlinkMacSystemFont,'SF Pro Display','Helvetica Neue',Arial,sans-serif" font-size="46" font-weight="600" font-style="regular" fill="var(--t1)" letter-spacing="-1">Stream</text>
        <text x="152" y="46" font-family="-apple-system,BlinkMacSystemFont,'SF Pro Display','Helvetica Neue',Arial,sans-serif" font-size="46" font-weight="800" font-style="bold" fill="var(--t1)" letter-spacing="-1">Gids</text>
        <!-- NL badge rechts van 'Gids', niet eroverheen -->
        <rect x="265" y="11" width="42" height="32" rx="8" fill="#E8001A"></rect>
        <text x="285" y="27" font-family="-apple-system,BlinkMacSystemFont,'SF Pro Display','Helvetica Neue',Arial,sans-serif" font-size="18" font-weight="800" fill="white" text-anchor="middle" dominant-baseline="middle">NL</text>
      </svg>
    </div>
    <div class="header-actions">
      <div class="source-pills">
        <span class="source-pill wm" id="wmBadge">WM</span>
        <span class="source-pill tmdb" id="tmdbBadge">TMDB</span>
      </div>
      <button class="theme-btn" id="toggleTheme" onclick="toggleTheme()" aria-label="Wissel thema (licht/donker)" title="Thema: licht/donker">Licht</button>
    </div>
  </header>

  <div class="pill-row" role="group" aria-label="Type filter">
    <button class="pill active" data-f="all"   onclick="setType(this)">Alles</button>
    <button class="pill"        data-f="movie" onclick="setType(this)">üé¨ Films</button>
    <button class="pill"        data-f="tv"    onclick="setType(this)">üì∫ Series</button>
  </div>

  <div id="svcBar" class="svc-bar"></div>

  <div class="nav-bar" id="navBar" style="display:none">
    <button class="nav-btn" id="btnPrev" onclick="shiftWindow(-7)">‚óÄ 1 week terug</button>
    <div class="nav-range" id="navRange"></div>
    <button class="nav-btn" id="btnNext" onclick="shiftWindow(7)">1 week verder ‚ñ∂</button>
  </div>

  <main id="main">
    <div class="loading-screen">
      <div class="spinner"></div>
      <div class="loading-text">Laden van de releases‚Ä¶</div>
      <div class="loading-sub" id="loadSub"></div>
    </div>
  </main>
</div>

<div id="overlay" onclick="closeBg(event)" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div class="sheet">
    <div class="drag" aria-hidden="true"></div>
    <div id="si" class="sheet-header"></div>
    <div id="sd" class="sheet-body"></div>
    <a id="wb" class="watch-btn" href="#" target="_blank" rel="noopener noreferrer" style="display:none">
      <span aria-hidden="true">‚ñ∂</span> Stream direct
    </a>
    <button id="shareBtn" class="share-btn" onclick="shareItem()" style="display:none" aria-label="Deel dit item">
      ‚¨ÜÔ∏è Delen
    </button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WM_KEY     = 'eLLuTN9mYhAAWBNl1P3XOGgRKFA1toAVWhOiYX3m';
const WM_BASE    = 'https://api.watchmode.com/v1';
const TMDB_TOKEN = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJiZWI4MDVlODg2MmYyODhkOTQ1NDhmOTU1NGYyZjc2YiIsIm5iZiI6MTY3OTQ3MzE2Ni43NzMsInN1YiI6IjY0MWFiYTBlZjlhYTQ3MDBiMTUxZGRmYSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.E73D999tD0DBX0aJVVfyooRa3T750C-Y_Hk1TZLr-EM';
const TMDB_BASE  = 'https://api.themoviedb.org/3';
const TMDB_IMG   = 'https://image.tmdb.org/t/p/w300';

// ‚îÄ‚îÄ Providers die we willen tonen als ze in NL beschikbaar zijn ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Gebaseerd op naam-matching (dynamisch opgehaald, IDs kunnen per regio wisselen)
const WANTED_PROVIDERS = [
  { match: 'netflix',       name: 'Netflix',        color: '#E50914', text: '#fff' },
  { match: 'prime video',   name: 'Prime Video',    color: '#00A8E0', text: '#fff' },
  { match: 'amazon prime',  name: 'Prime Video',    color: '#00A8E0', text: '#fff' },
  { match: 'disney plus',   name: 'Disney+',        color: '#113CCF', text: '#fff' },
  { match: 'disney+',       name: 'Disney+',        color: '#113CCF', text: '#fff' },
  { match: 'apple tv plus', name: 'Apple TV+',      color: '#555555', text: '#fff' },
  { match: 'apple tv+',     name: 'Apple TV+',      color: '#555555', text: '#fff' },
  { match: 'apple tv',      name: 'Apple TV+',      color: '#555555', text: '#fff' },
  { match: 'max ',          name: 'Max',            color: '#5822B4', text: '#fff' },
  { match: 'hbo max',       name: 'Max',            color: '#5822B4', text: '#fff' },
  { match: 'skyshowtime',   name: 'SkyShowtime',    color: '#003E7E', text: '#fff' },
  { match: 'videoland',     name: 'Videoland',      color: '#CC0000', text: '#fff' },
  { match: 'path',          name: 'Path√© Thuis',    color: '#FF6B00', text: '#fff' },
  { match: 'npo',           name: 'NPO Start',      color: '#FF6600', text: '#fff' },
  { match: 'paramount',     name: 'Paramount+',     color: '#0064FF', text: '#fff' },
  { match: 'discovery',     name: 'Discovery+',     color: '#0036A0', text: '#fff' },
  { match: 'viaplay',       name: 'Viaplay',        color: '#1F1646', text: '#fff' },
  { match: 'canal',         name: 'Canal+',         color: '#000000', text: '#fff' },
  { match: 'mubi',          name: 'MUBI',           color: '#00B4B4', text: '#fff' },
  { match: 'cinemember',    name: 'CineMember',     color: '#E8003D', text: '#fff' },
  { match: 'film1',         name: 'Film1',          color: '#D10000', text: '#fff' },
];

// Populaire diensten eerst in de filterbalk
const POPULAR_KEYS = [
  'netflix',
  'prime video',
  'hbo max',
  'max ',
  'disney plus',
  'disney+',
  'videoland',
  'apple tv plus',
  'apple tv+',
  'skyshowtime',
  'viaplay',
  'path',
  'npo',
  'paramount',
  'mubi',
  'cinemember',
  'film1',
  'canal',
];

// Runtime: wordt gevuld door fetchTMDBProviders()
let TMDB_NL_PROVIDERS = {}; // { id: { name, color, text, logo } }

// ‚îÄ‚îÄ Stijl helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function matchProvider(name) {
  const lower = (name || '').toLowerCase().replace(/[^a-z0-9\s]/g,'').trim();
  return WANTED_PROVIDERS.find(p => lower.includes(p.match));
}

function getSvcStyle(name = '') {
  const p = matchProvider(name);
  return p ? { color: p.color, text: p.text } : { color: '#444444', text: '#fff' };
}

function providerKey(name) {
  const p = matchProvider(name);
  return p ? p.match : (name || '').toLowerCase().replace(/netherlands/gi,'').replace(/\s+/g,' ').trim();
}

function isNLStreaming(name) {
  return !!matchProvider(name);
}

function detectOrigin(svcName) {
  const n = (svcName || '').toLowerCase();
  return ['netflix','disney','max','hbo','videoland','apple','npo'].some(s => n.includes(s))
    ? 'original' : 'licensed';
}

function resolveType(apiType) {
  if (!apiType) return null;
  const t = String(apiType).toLowerCase();
  if (t === 'movie') return 'movie';
  if (t.startsWith('tv_') || t.includes('series') || t.includes('miniseries') || t.includes('special')) return 'tv';
  return null;
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allItems = [];
let typeFilter = 'all', svcFilter = 'all';
const detailCache = {};
const imgCache = {}; // itemId -> best known poster URL
const WINDOW_SIZE = 7;
let allDays = [], windowStart = 0;
let wmSources = [];
let wmSourceMap = {}; // id -> bronobject (alle NL sources)
let currentModalItem = null; // voor Web Share

// ‚îÄ‚îÄ Favorieten (localStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let favServices = JSON.parse(localStorage.getItem('streamgids_favs') || '[]');
function toggleFavService(key, btnEl) {
  const idx = favServices.indexOf(key);
  if (idx > -1) favServices.splice(idx, 1); else favServices.push(key);
  localStorage.setItem('streamgids_favs', JSON.stringify(favServices));
  if (btnEl) btnEl.classList.toggle('active', favServices.includes(key));
  buildSvcBar();
}
function isFav(key) { return favServices.includes(key); }

// ‚îÄ‚îÄ Thema (localStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyTheme(theme) {
  if (theme === 'light') {
    document.body.dataset.theme = 'light';
  } else {
    delete document.body.dataset.theme;
  }
  const btn = document.getElementById('toggleTheme');
  if (btn) btn.textContent = theme === 'light' ? 'Donker' : 'Licht';
}
function toggleTheme() {
  const isLight = document.body.dataset.theme === 'light';
  const next = isLight ? 'dark' : 'light';
  applyTheme(next);
  localStorage.setItem('streamgids_theme', next);
}

// ‚îÄ‚îÄ Web Share API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function shareItem() {
  if (!currentModalItem) return;
  const title = currentModalItem.title || 'StreamGids';
  const text = `Bekijk "${title}" via StreamGids`;
  if (navigator.share) {
    try { await navigator.share({ title, text, url: window.location.href }); }
    catch(e) { console.log('Delen geannuleerd:', e); }
  } else {
    const wa = `https://wa.me/?text=${encodeURIComponent(text + ' ' + window.location.href)}`;
    window.open(wa, '_blank');
  }
}

// ‚îÄ‚îÄ API response cache (sessionStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function scGet(key) {
  try { const v = sessionStorage.getItem(key); return v ? JSON.parse(v) : null; } catch { return null; }
}
function scSet(key, val) {
  try { sessionStorage.setItem(key, JSON.stringify(val)); } catch {}
}

// ‚îÄ‚îÄ Datum helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dateOffset(offset) {
  const d = new Date(); d.setDate(d.getDate() + offset);
  return d.toISOString().slice(0, 10);
}
function dateStr(offset = 0) { return dateOffset(offset).replace(/-/g, ''); }
function isoDate(wmDate) {
  if (!wmDate) return '';
  const s = String(wmDate);
  if (s.includes('-')) return s.slice(0, 10);
  return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
}
function todayISO() { return new Date().toISOString().slice(0, 10); }
function dayName(iso) {
  const n = new Date(iso + 'T12:00:00').toLocaleDateString('nl-NL', { weekday: 'long' });
  return n.charAt(0).toUpperCase() + n.slice(1);
}
function fullDate(iso) {
  return new Date(iso + 'T12:00:00').toLocaleDateString('nl-NL', { day:'numeric', month:'long', year:'numeric' });
}
function shortDate(iso) {
  return new Date(iso + 'T12:00:00').toLocaleDateString('nl-NL', { day:'numeric', month:'short' });
}

// ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function wm(path, params = {}) {
  const url = new URL(WM_BASE + path);
  url.searchParams.set('apiKey', WM_KEY);
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
  const cKey = 'wm_' + url.toString();
  const cached = scGet(cKey);
  if (cached) return cached;
  const r = await fetch(url.toString());
  if (!r.ok) throw new Error(`Watchmode ${r.status}`);
  const data = await r.json();
  scSet(cKey, data);
  return data;
}

async function tmdb(path, params = {}) {
  const url = new URL(TMDB_BASE + path);
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
  const cKey = 'tmdb_' + url.toString();
  const cached = scGet(cKey);
  if (cached) return cached;
  const r = await fetch(url.toString(), {
    headers: { 'Authorization': `Bearer ${TMDB_TOKEN}`, 'Content-Type': 'application/json' }
  });
  if (!r.ok) throw new Error(`TMDB ${r.status} (${path})`);
  const data = await r.json();
  scSet(cKey, data);
  return data;
}

async function translateToNL(text) {
  if (!text || !text.trim()) return 'Geen beschrijving beschikbaar.';
  try {
    const r = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text.slice(0, 500))}&langpair=en|nl`);
    const d = await r.json();
    const t = d?.responseData?.translatedText;
    return (t && t !== text && !t.toLowerCase().includes('mymemory')) ? t : text;
  } catch { return text; }
}

// ‚îÄ‚îÄ Watchmode ophalen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchWMSources() {
  try {
    const data = await wm('/sources', { regions: 'NL' });
    const all = Array.isArray(data) ? data : [];
    // Sla ALLES op in de map, zodat we later elke source_id kunnen opzoeken
    all.filter(s => s.regions?.includes('NL')).forEach(s => {
      wmSourceMap[s.id] = s;
    });
    wmSources = all
      .filter(s => s.type === 'sub' && s.regions?.includes('NL'))
      .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
    document.getElementById('wmBadge').title = `Watchmode: ${wmSources.length} diensten`;
  } catch(e) {
    console.warn('WM sources failed:', e);
    wmSources = [];
  }
}

async function fetchWMReleases() {
  // Venster: 60 dagen terug tot 30 dagen vooruit
  const from = dateStr(-60), to = dateStr(30);
  const [movRes, tvRes] = await Promise.all([
    wm('/releases', { regions:'NL', start_date:from, end_date:to, types:'movie', limit:500 }),
    wm('/releases', { regions:'NL', start_date:from, end_date:to, types:'tv_series,tv_miniseries,tv_special,tv_movie', limit:500 }),
  ]);

  function parse(res, fallbackType) {
    return (res?.releases || []).map(item => {
      // Gebruik wmSourceMap voor bekende IDs, val terug op source_name uit de release
      const src = wmSourceMap[item.source_id] || { name: item.source_name || '' };
      const svcName = (src.name || '').replace(/Netherlands/gi,'').trim();

      // Neem ALLES mee wat een herkenbare naam heeft ‚Äî niet weggooien op ID
      if (!svcName || (!isNLStreaming(svcName) && !src.regions?.includes('NL'))) return null;

      const resolved = resolveType(item.type || item.title_type) || fallbackType;
      return {
        ...item,
        img: item.poster_url || null,
        _type: resolved,
        _date: isoDate(item.source_release_date),
        _src: { ...src, name: svcName || src.name },
        _style: getSvcStyle(svcName),
        _key: providerKey(svcName),
        _originType: detectOrigin(svcName),
        _source: 'watchmode',
        _season: item.season_number || null,
      };
    }).filter(Boolean);
  }

  return [...parse(movRes, 'movie'), ...parse(tvRes, 'tv')];
}

// ‚îÄ‚îÄ TMDB: dynamisch providers ophalen voor NL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchTMDBProviders() {
  const [movData, tvData] = await Promise.all([
    tmdb('/watch/providers/movie', { watch_region: 'NL', language: 'nl-NL' }),
    tmdb('/watch/providers/tv',    { watch_region: 'NL', language: 'nl-NL' }),
  ]);

  const seen = new Set();
  [...(movData.results||[]), ...(tvData.results||[])].forEach(p => {
    if (seen.has(p.provider_id)) return;
    seen.add(p.provider_id);

    const matched = matchProvider(p.provider_name);
    if (!matched) return; // alleen providers die we willen tonen

    TMDB_NL_PROVIDERS[p.provider_id] = {
      name:  matched.name,
      color: matched.color,
      text:  matched.text,
      logo:  p.logo_path ? `https://image.tmdb.org/t/p/original${p.logo_path}` : null,
      rawName: p.provider_name,
    };
  });

  const count = Object.keys(TMDB_NL_PROVIDERS).length;
  document.getElementById('tmdbBadge').title = `TMDB: ${count} NL providers gevonden`;
  console.log('TMDB NL providers:', Object.values(TMDB_NL_PROVIDERS).map(p=>`${p.name} (${p.rawName})`));
}

// Haal meerdere pagina's op
async function tmdbPages(path, params, maxPages = 3) {
  const first = await tmdb(path, { ...params, page: 1 }).catch(() => ({ results: [], total_pages: 0 }));
  const all = [...(first.results || [])];
  const total = Math.min(first.total_pages || 1, maxPages);
  if (total > 1) {
    const rest = await Promise.all(
      Array.from({ length: total - 1 }, (_, i) =>
        tmdb(path, { ...params, page: i + 2 }).catch(() => ({ results: [] }))
      )
    );
    rest.forEach(r => all.push(...(r.results || [])));
  }
  return all;
}

async function fetchTMDBReleases() {
  const items = [];
  const providerEntries = Object.entries(TMDB_NL_PROVIDERS);
  if (!providerEntries.length) return [];

  function makeItem(m, prov, id, type) {
    const date = type === 'movie' ? (m.release_date || '') : (m.first_air_date || '');
    if (!date || !m.id) return null;
    return {
      id: `tmdb-${m.id}-${id}`,
      title: m.title || m.name || m.original_title || m.original_name || '',
      img: m.poster_path ? `${TMDB_IMG}${m.poster_path}` : null,
      _type: type, _date: date,
      _src: { name: prov.name, logo_100px: prov.logo },
      _style: { color: prov.color, text: prov.text },
      _key: providerKey(prov.name),
      _originType: detectOrigin(prov.name),
      _source: 'tmdb', _providerId: Number(id),
      tmdb_id: m.id, user_rating: m.vote_average || 0, overview: m.overview || '',
    };
  }

  // ‚îÄ‚îÄ Strategie A: now_playing + on_the_air ‚Äî meest actuele TMDB content ‚îÄ‚îÄ
  // Per item controleren welke NL providers het hebben (per-item watch/providers call)
  document.getElementById('loadSub').textContent = 'TMDB: actuele titels ophalen‚Ä¶';
  try {
    const [nowMov, onAirTV] = await Promise.all([
      tmdbPages('/movie/now_playing', { language:'nl-NL', region:'NL' }, 5),
      tmdbPages('/tv/on_the_air',     { language:'nl-NL' }, 5),
    ]);
    // Batch: provider-check per item (max 60 items om rate limit te vermijden)
    const checkItems = [
      ...nowMov.slice(0, 50).map(m => ({ ...m, _isTV: false })),
      ...onAirTV.slice(0, 50).map(t => ({ ...t, _isTV: true })),
    ];
    const batchSize = 10;
    for (let i = 0; i < checkItems.length; i += batchSize) {
      await Promise.all(checkItems.slice(i, i + batchSize).map(async m => {
        try {
          const pd = await tmdb(`/${m._isTV ? 'tv' : 'movie'}/${m.id}/watch/providers`);
          const flat = pd?.results?.NL?.flatrate || [];
          for (const p of flat) {
            const prov = TMDB_NL_PROVIDERS[p.provider_id];
            if (!prov) continue;
            const it = makeItem(m, prov, p.provider_id, m._isTV ? 'tv' : 'movie');
            if (it) items.push(it);
          }
        } catch {}
      }));
    }
  } catch(e) { console.warn('TMDB now_playing/on_the_air:', e); }

  // ‚îÄ‚îÄ Strategie B: discover per provider (populair, afgelopen 3 jaar) ‚îÄ‚îÄ
  // Geeft volledige cataloog van bijv. Videoland / Path√© Thuis / NPO
  const BATCH = 4;
  for (let i = 0; i < providerEntries.length; i += BATCH) {
    const batch = providerEntries.slice(i, i + BATCH);
    document.getElementById('loadSub').textContent =
      `TMDB: ${batch.map(([,p]) => p.name).join(', ')}‚Ä¶`;

    await Promise.all(batch.map(async ([id, prov]) => {
      const base = {
        watch_region: 'NL', with_watch_providers: id,
        with_watch_monetization_types: 'flatrate',
        language: 'nl-NL', sort_by: 'popularity.desc',
      };
      const cutoff = dateOffset(-1095); // 3 jaar
      const [movs, tvs] = await Promise.all([
        tmdbPages('/discover/movie', { ...base, 'primary_release_date.gte': cutoff }, 5).catch(() => []),
        tmdbPages('/discover/tv',    { ...base, 'first_air_date.gte': cutoff }, 5).catch(() => []),
      ]);
      movs.forEach(m => { const it = makeItem(m, prov, id, 'movie'); if (it) items.push(it); });
      tvs.forEach(t  => { const it = makeItem(t, prov, id, 'tv');    if (it) items.push(it); });
    })).catch(e => console.warn('TMDB discover batch:', e));
  }

  document.getElementById('tmdbBadge').textContent = `TMDB ${items.length}`;
  return items;
}


// ‚îÄ‚îÄ Samenvoegen & dedupliceren ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mergeItems(wmItems, tmdbItems) {
  const result = [];
  const seen = new Set(); // "title-lowercase|providerKey"

  // WM items eerst
  for (const item of wmItems) {
    if (!item._date) continue;
    const k = `${(item.title||'').toLowerCase().trim()}|${item._key}`;
    if (seen.has(k)) continue;
    seen.add(k);
    result.push(item);
  }

  // TMDB: voeg toe als niet al in WM (zelfde titel + zelfde dienst)
  // Maar: zelfde film op Netflix √©n op Videoland moet w√©l allebei verschijnen
  const tmdbSeen = new Set(); // "tmdb_id|providerKey" ‚Äî per dienst √©√©n keer
  for (const item of tmdbItems) {
    if (!item._date || !item.title) continue;
    const dupKey = `${item.tmdb_id}|${item._key}`;
    if (tmdbSeen.has(dupKey)) continue;
    tmdbSeen.add(dupKey);

    const titleKey = `${(item.title||'').toLowerCase().trim()}|${item._key}`;
    if (seen.has(titleKey)) continue;
    seen.add(titleKey);
    result.push(item);
  }

  return result;
}

// ‚îÄ‚îÄ Service bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildSvcBar() {
  const bar = document.getElementById('svcBar');
  const provMap = new Map(); // providerKey -> { name, style, logo }

  for (const item of allItems) {
    const key = item._key || '';
    if (provMap.has(key)) continue;
    const logo = item._src?.logo_100px || null;
    provMap.set(key, { name: item._src?.name || key, style: item._style, logo });
  }

  // Populaire diensten eerst, daarna alfabetisch (favorieten blijven bovenaan)
  const entries = [...provMap.entries()].sort((a, b) => {
    const aFav = isFav(a[0]) ? 0 : 1;
    const bFav = isFav(b[0]) ? 0 : 1;
    if (aFav !== bFav) return aFav - bFav;

    const keyA = String(a[0]).toLowerCase();
    const keyB = String(b[0]).toLowerCase();
    const rankA = POPULAR_KEYS.indexOf(keyA);
    const rankB = POPULAR_KEYS.indexOf(keyB);
    const aRank = rankA === -1 ? 999 : rankA;
    const bRank = rankB === -1 ? 999 : rankB;
    if (aRank !== bRank) return aRank - bRank;

    return a[1].name.localeCompare(b[1].name);
  });

  bar.innerHTML = `<button class="sc active" data-k="all" onclick="setSvc(this)" aria-pressed="true">‚≠ê Alle streamers</button>`;
  entries.forEach(([key, info]) => {
    const logoEl = info.logo
      ? `<img src="${info.logo}" alt="${info.name} logo" onerror="this.style.display='none'" loading="lazy">`
      : `<div class="dot" style="background:${info.style.color}" aria-hidden="true"></div>`;
    const favStar = isFav(key) ? '‚≠ê ' : '';
    bar.innerHTML += `<button class="sc${svcFilter===key?' active':''}" data-k="${key}" onclick="setSvc(this)" aria-pressed="${svcFilter===key}">${logoEl}${favStar}${info.name}</button>`;
  });
}

// ‚îÄ‚îÄ Filters & rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filteredItems() {
  return allItems.filter(i => {
    if (typeFilter === 'movie' && i._type !== 'movie') return false;
    if (typeFilter === 'tv'    && i._type !== 'tv')    return false;
    if (svcFilter !== 'all'   && i._key !== svcFilter) return false;
    return !!i._date;
  });
}

function buildDayList() {
  const set = new Set();
  for (let i = -30; i <= 30; i++) {
    const d = new Date(); d.setDate(d.getDate() + i);
    set.add(d.toISOString().slice(0, 10));
  }
  filteredItems().forEach(i => set.add(i._date));
  allDays = [...set].sort();

  const today = todayISO();
  let idx = allDays.indexOf(today);
  if (idx === -1) { idx = allDays.findIndex(d => d >= today); }
  if (idx === -1) { idx = Math.max(0, allDays.length - WINDOW_SIZE); }
  windowStart = idx;
}

function grouped() {
  const map = {};
  filteredItems().forEach(i => {
    if (!map[i._date]) map[i._date] = { movies: [], tv: [] };
    (i._type === 'movie' ? map[i._date].movies : map[i._date].tv).push(i);
  });
  return map;
}

function shiftWindow(delta) {
  windowStart = Math.max(0, Math.min(allDays.length - WINDOW_SIZE, windowStart + delta));
  renderAll();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateNavBar() {
  const bar = document.getElementById('navBar');
  if (!allDays.length) { bar.style.display = 'none'; return; }
  bar.style.display = 'flex';
  const vis = allDays.slice(windowStart, windowStart + WINDOW_SIZE);
  document.getElementById('navRange').textContent = vis.length
    ? `${shortDate(vis[0])} ‚Äì ${shortDate(vis[vis.length-1])}` : '';
  document.getElementById('btnPrev').disabled = windowStart <= 0;
  document.getElementById('btnNext').disabled = windowStart + WINDOW_SIZE >= allDays.length;
}

function renderAll() {
  const main = document.getElementById('main');
  main.innerHTML = '';
  const g = grouped();
  const today = todayISO();
  const vis = allDays.slice(windowStart, windowStart + WINDOW_SIZE);

  vis.forEach((iso, i) => {
    const data = g[iso];
    const movies = data?.movies || [], tv = data?.tv || [];
    const sec = document.createElement('section');
    sec.className = 'day-section';
    sec.style.animationDelay = `${i * 0.04}s`;
    const chip = iso === today ? '<span class="today-chip">Vandaag</span>' : '';
    let html = `
      <div class="day-header"><div class="day-name">${dayName(iso)}</div>${chip}</div>
      <div class="day-sub">${fullDate(iso)}</div>`;
    if (!movies.length && !tv.length) {
      html += `<div class="empty-day">Geen nieuwe releases op deze dag.</div>`;
    } else {
      if (movies.length) html += `<div class="cat-row">Films (${movies.length})</div><div class="scroll-track">${movies.map(cardHtml).join('')}</div>`;
      if (tv.length)     html += `<div class="cat-row">Series (${tv.length})</div><div class="scroll-track">${tv.map(cardHtml).join('')}</div>`;
    }
    html += '<div class="divider"></div>';
    sec.innerHTML = html;
    main.appendChild(sec);
  });

  if (!vis.length) {
    main.innerHTML = `<div class="loading-screen"><div class="loading-text">Geen releases gevonden voor deze periode.</div></div>`;
  }
  updateNavBar();
}

// Wordt aangeroepen door onerror op card-poster img
// Zoekt via TMDB een poster op titel en werkt de img bij
async function cardImgError(imgEl, itemId) {
  imgEl.style.display = 'none';
  const fallback = imgEl.nextElementSibling;
  if (fallback) fallback.style.display = 'flex';

  // Check cache eerst
  if (imgCache[itemId]) {
    imgEl.src = imgCache[itemId];
    imgEl.style.display = 'block';
    if (fallback) fallback.style.display = 'none';
    return;
  }

  // TMDB zoeken op titel
  const item = allItems.find(i => String(i.id) === String(itemId));
  if (!item || !item.title) return;
  try {
    const type = item._type === 'movie' ? 'movie' : 'tv';
    const res = await tmdb(`/search/${type}`, { query: item.title, language: 'nl-NL' });
    const hit = (res.results || []).find(r => r.poster_path);
    if (hit?.poster_path) {
      const url = `${TMDB_IMG}${hit.poster_path}`;
      imgCache[itemId] = url;
      item.img = url; // update voor volgende render
      imgEl.src = url;
      imgEl.style.display = 'block';
      if (fallback) fallback.style.display = 'none';
    }
  } catch {}
}

function cardHtml(item) {
  const title = (item.title || '').replace(/'/g, "&#39;").replace(/"/g, '&quot;');
  const { color, text } = item._style;
  const svcName = (item._src?.name || 'Streaming').replace(/Netherlands/gi,'').trim();
  const oCls = item._originType === 'original' ? 'original' : 'licensed';
  const oTxt = item._originType === 'original' ? 'Origineel' : 'Gelicenseerd';
  const safeId = String(item.id).replace(/['"\\]/g, '');
  const safeKey = (item._key || '').replace(/['"\\]/g, '');

  // Poster: gebruik imgCache als beschikbaar, anders item.img
  const posterSrc = imgCache[item.id] || item.img || '';
  const imgEl = posterSrc
    ? `<img class="poster" src="${posterSrc}" alt="Poster van ${title}" loading="lazy" onerror="cardImgError(this,'${safeId}')">`
    : '';
  const fallD = posterSrc ? 'none' : 'flex';

  const rating = item.user_rating ? `‚≠ê ${Number(item.user_rating).toFixed(1)}` : (item._type==='movie'?'Film':'Serie');
  const srcColor = item._source === 'watchmode' ? 'var(--accent)' : 'var(--accent2)';

  // Seizoensbadge: toon als seizoen bekend is (WM geeft het direct mee)
  const seasonBadge = (item._type === 'tv' && item._season && item._season > 1)
    ? `<div class="season-badge">S${item._season}</div>` : '';

  const favActive = isFav(safeKey) ? ' active' : '';

  return `
    <div class="card" onclick="openModal('${safeId}')" role="article" aria-label="${title} op ${svcName}">
      <div class="card-poster">
        ${imgEl}
        <div class="fallback" style="display:${fallD}" aria-hidden="true"><span>${title}</span></div>
        ${seasonBadge}
        <div class="badge" style="background:${color}dd;color:${text}">${svcName}</div>
        <div class="src-dot" style="background:${srcColor}" title="${item._source}" aria-hidden="true"></div>
        <button class="fav-btn${favActive}" onclick="event.stopPropagation();toggleFavService('${safeKey}',this)" aria-label="${isFav(safeKey)?'Verwijder uit':'Voeg toe aan'} favorieten" title="Favoriet">‚ô•</button>
      </div>
      <div class="card-title">${title}</div>
      <div class="card-meta">${rating}<span class="origin-badge ${oCls}">${oTxt}</span></div>
    </div>`;
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openModal(rawId) {
  const overlay = document.getElementById('overlay');
  const si = document.getElementById('si'), sd = document.getElementById('sd'), wb = document.getElementById('wb');
  const shareBtn = document.getElementById('shareBtn');

  const item = allItems.find(i => String(i.id) === String(rawId));
  if (!item) return;
  currentModalItem = item;

  const { title, img, _src, _style, _type, _originType, _source, tmdb_id, watchmode_id } = item;
  const svcName = (_src?.name || 'Streaming').replace(/Netherlands/gi,'').trim();
  const { color } = _style;

  // Gebruik imgCache als we al een betere poster hebben
  const initPoster = imgCache[item.id] || img || '';

  si.innerHTML = `
    <div class="sp">${initPoster?`<img src="${initPoster}" alt="">`:''}</div>
    <div class="sinf">
      <div class="ssvc" style="color:${color}">${svcName}</div>
      <div class="stitle">${title}</div>
      <div class="smeta">${_type==='movie'?'Film':'Serie'}</div>
      <div style="color:var(--t3);font-size:12px">Details laden‚Ä¶</div>
    </div>`;
  sd.textContent = 'Beschrijving laden‚Ä¶'; wb.style.display = 'none';
  if (shareBtn) shareBtn.style.display = 'flex';
  overlay.classList.add('open'); document.body.style.overflow = 'hidden';

  let fullTitle = title, year = '', runtime = '', rating = '', genres = '', posterUrl = initPoster;
  let rawOverview = item.overview || '';
  let watchLink = null;
  let seasonInfo = item._season ? `Seizoen ${item._season}` : ''; // WM geeft dit direct

  // ‚îÄ‚îÄ TMDB detail ‚îÄ‚îÄ
  const resolvedTmdbId = tmdb_id || (_source === 'tmdb' ? String(rawId).replace(/tmdb-(\d+)-.*/,'$1') : null);
  if (resolvedTmdbId) {
    const cKey = `tmdb-${_type}-${resolvedTmdbId}`;
    if (!detailCache[cKey]) {
      try {
        const path = _type === 'movie' ? `/movie/${resolvedTmdbId}` : `/tv/${resolvedTmdbId}`;
        const [det, prov] = await Promise.all([
          tmdb(path, { language: 'nl-NL' }),
          tmdb(`${path}/watch/providers`),
        ]);
        detailCache[cKey] = { det, prov };
      } catch(e) { console.warn('TMDB detail:', e); detailCache[cKey] = null; }
    }
    const cached = detailCache[cKey];
    if (cached?.det) {
      const d = cached.det;
      fullTitle   = d.title || d.name || title;
      year        = (d.release_date || d.first_air_date || '').slice(0, 4);
      runtime     = d.runtime ? `${d.runtime} min` : (d.episode_run_time?.[0] ? `${d.episode_run_time[0]} min/afl` : '');
      rating      = d.vote_average ? `${Number(d.vote_average).toFixed(1)} / 10` : '';
      genres      = (d.genres || []).slice(0, 4).map(g => `<span class="stag">${g.name}</span>`).join('');
      rawOverview = d.overview || rawOverview;

      // Seizoen: number_of_seasons voor series
      if (_type === 'tv' && d.number_of_seasons) {
        seasonInfo = `Seizoen ${d.number_of_seasons}`;
        // Sla seizoen op in item voor card-weergave
        if (!item._season) item._season = d.number_of_seasons;
      }

      if (d.poster_path) {
        posterUrl = `${TMDB_IMG}${d.poster_path}`;
        // Sla op in cache zodat card direct de goede poster krijgt
        imgCache[item.id] = posterUrl;
        // Update de card img direct in de DOM als die zichtbaar is
        const cardImg = document.querySelector(`.card[onclick*="'${String(item.id).replace(/['"\\]/g,'')}'""] .poster`);
        if (cardImg) {
          cardImg.src = posterUrl;
          cardImg.style.display = 'block';
          const fb = cardImg.nextElementSibling;
          if (fb?.classList.contains('fallback')) fb.style.display = 'none';
        }
      }

      const nlProv = cached.prov?.results?.NL;
      if (nlProv?.link) watchLink = nlProv.link;
    }
  }

  // ‚îÄ‚îÄ Watchmode detail (fallback of aanvulling) ‚îÄ‚îÄ
  const wmId = watchmode_id || (_source === 'watchmode' ? rawId : null);
  if (wmId && String(wmId) !== '0') {
    const wKey = `wm-${wmId}`;
    if (!detailCache[wKey]) {
      try { detailCache[wKey] = await wm(`/title/${wmId}/details`); } catch { detailCache[wKey] = null; }
    }
    const d = detailCache[wKey];
    if (d) {
      if (!year)        year     = d.year ? String(d.year) : year;
      if (!runtime)     runtime  = d.runtime_minutes ? `${d.runtime_minutes} min` : '';
      if (!rating)      rating   = d.user_rating ? `${Number(d.user_rating).toFixed(1)} / 10` : '';
      if (!genres && d.genres) genres = (d.genres||[]).slice(0,4).map(g => {
        const n = typeof g === 'object' ? (g.name||'') : (typeof g === 'string' ? g : '');
        return (!isNaN(n)||!n) ? '' : `<span class="stag">${n}</span>`;
      }).filter(Boolean).join('');
      if (!posterUrl && d.poster) {
        posterUrl = d.poster;
        imgCache[item.id] = posterUrl;
      }
      if (!rawOverview) rawOverview = d.plot_overview || '';
      if (!watchLink && d.sources?.length) {
        const nlSub = d.sources.find(s => s.region==='NL' && s.type==='sub');
        const usSub = d.sources.find(s => s.region==='US' && s.type==='sub');
        const nlAny = d.sources.find(s => s.region==='NL');
        watchLink = nlSub?.web_url || usSub?.web_url || nlAny?.web_url || d.sources[0]?.web_url || null;
      }
    }
  }

  // ‚îÄ‚îÄ Fallback watch links ‚îÄ‚îÄ
  if (!watchLink) {
    const svc = (_src?.name || '').toLowerCase();
    if      (svc.includes('netflix'))                      watchLink = `https://www.netflix.com/search?q=${encodeURIComponent(fullTitle)}`;
    else if (svc.includes('prime')||svc.includes('amazon')) watchLink = `https://www.amazon.nl/s?k=${encodeURIComponent(fullTitle)}`;
    else if (svc.includes('disney'))                       watchLink = `https://www.disneyplus.com/search/${encodeURIComponent(fullTitle)}`;
    else if (svc.includes('apple'))                        watchLink = `https://tv.apple.com/`;
    else if (svc.includes('max')||svc.includes('hbo'))     watchLink = `https://www.max.com/`;
    else if (svc.includes('sky'))                          watchLink = `https://www.skyshowtime.com/`;
    else if (svc.includes('videoland'))                    watchLink = `https://www.videoland.com/`;
    else if (svc.includes('path√©')||svc.includes('pathe')) watchLink = `https://www.pathe-thuis.nl/`;
    else if (svc.includes('npo'))                          watchLink = `https://npo.nl/`;
    else if (svc.includes('paramount'))                    watchLink = `https://www.paramountplus.com/nl/`;
    else if (svc.includes('discovery'))                    watchLink = `https://www.discoveryplus.com/nl/`;
  }

  // ‚îÄ‚îÄ Vertalen als nodig (niet blokkeren) ‚îÄ‚îÄ
  let nlOverview = rawOverview || 'Geen beschrijving beschikbaar.';

  const oBadge = _originType === 'original'
    ? '<div class="origin-badge original" style="display:inline-block;margin-top:4px">Originele content</div>'
    : '<div class="origin-badge licensed" style="display:inline-block;margin-top:4px">Gelicenseerde content</div>';

  // smeta: type ¬∑ jaar ¬∑ runtime ¬∑ seizoen
  const metaParts = [_type === 'movie' ? 'Film' : 'Serie'];
  if (year) metaParts.push(year);
  if (runtime) metaParts.push(runtime);
  if (_type === 'tv' && seasonInfo) metaParts.push(seasonInfo);

  si.innerHTML = `
    <div class="sp">${posterUrl?`<img src="${posterUrl}" alt="">`:''}</div>
    <div class="sinf">
      <div class="ssvc" style="color:${color}">${svcName}</div>
      <div class="stitle">${fullTitle}</div>
      <div class="smeta">${metaParts.join(' ¬∑ ')}</div>
      <div class="stags">${genres}</div>
      ${rating?`<div class="srating"><span style="color:#FFD60A">‚òÖ</span> ${rating}</div>`:''}
      ${oBadge}
    </div>`;
  sd.textContent = nlOverview;
  // Start optionele vertaling op de achtergrond, zonder de UI te blokkeren
  if (rawOverview && /^[A-Za-z\s]{20,}/.test(rawOverview.slice(0, 60))) {
    translateToNL(rawOverview).then(txt => {
      const finalText = txt && txt !== rawOverview ? txt : nlOverview;
      if (currentModalItem === item) {
        sd.textContent = finalText;
      }
    }).catch(() => {});
  }
  if (watchLink) { wb.href = watchLink; wb.style.display = 'flex'; }
}

function closeBg(e) {
  if (e.target === document.getElementById('overlay')) {
    document.getElementById('overlay').classList.remove('open');
    document.body.style.overflow = '';
    currentModalItem = null;
  }
}

function setType(el) {
  typeFilter = el.dataset.f;
  document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  buildDayList(); renderAll();
}

function setSvc(el) {
  svcFilter = el.dataset.k;
  document.querySelectorAll('.sc').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  buildDayList(); renderAll();
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Thema initialiseren zodra DOM klaar is
(function() {
  const saved = localStorage.getItem('streamgids_theme');
  const preferred = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
  applyTheme(saved || preferred);
})();

// Keyboard: ESC sluit de modal
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    const overlay = document.getElementById('overlay');
    if (overlay.classList.contains('open')) {
      overlay.classList.remove('open');
      document.body.style.overflow = '';
      currentModalItem = null;
    }
  }
});
async function init() {
  try {
    const loading = document.querySelector('.loading-text');
    const loadSub = document.getElementById('loadSub');

    loading.textContent = 'Streamingdiensten ophalen‚Ä¶';
    loadSub.textContent = 'Watchmode + TMDB Nederland';

    // Stap 1: beide service-lijsten ophalen
    const [,] = await Promise.all([
      fetchWMSources().catch(e => console.warn('WM sources:', e)),
      fetchTMDBProviders().catch(e => console.warn('TMDB providers:', e)),
    ]);

    const tmdbCount = Object.keys(TMDB_NL_PROVIDERS).length;
    document.getElementById('tmdbBadge').textContent = `TMDB ${tmdbCount} diensten`;

    loading.textContent = 'Releases laden‚Ä¶';
    loadSub.textContent = `${wmSources.length} WM + ${tmdbCount} TMDB diensten`;

    // Stap 2: releases ophalen van beide bronnen
    const [wmItems, tmdbItems] = await Promise.all([
      fetchWMReleases().catch(e => { console.warn('WM releases:', e); return []; }),
      fetchTMDBReleases().catch(e => { console.warn('TMDB releases:', e); return []; }),
    ]);

    loadSub.textContent = '';
    allItems = mergeItems(wmItems, tmdbItems);

    document.getElementById('wmBadge').textContent = `WM ${wmItems.length}`;
    document.getElementById('tmdbBadge').textContent = `TMDB ${tmdbItems.length}`;

    if (!allItems.length) throw new Error('Geen releases gevonden voor Nederland.');

    buildSvcBar();
    buildDayList();
    renderAll();
  } catch(e) {
    console.error(e);
    document.getElementById('main').innerHTML = `
      <div class="error-screen">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-title">Kon releases niet laden</div>
        <div class="error-msg">${e.message || 'Controleer je internetverbinding.'}</div>
        <button class="retry-btn" onclick="location.reload()">Opnieuw proberen</button>
      </div>`;
  }
}
init();
</script>
</body>
</html>
